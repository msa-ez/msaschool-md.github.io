<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>쿠버네티스 내부구조 분석 - msaez</title><meta name="gridsome:hash" content="639846ab77f2d650b364be948c0c3d68be620b02"><meta data-vue-meta="ssr" charset="utf-8"><meta data-vue-meta="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-meta="ssr" key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-meta="ssr" key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-argo-rollout-canary-istio/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-deploy-my-app/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-service-mesh-istio/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-anatomy-kubernetes/"><meta data-vue-meta="ssr" name="description" content="undefined"><meta data-vue-meta="ssr" key="og:title" name="og:title" content="쿠버네티스 내부구조 분석"><meta data-vue-meta="ssr" key="twitter:title" name="twitter:title" content="쿠버네티스 내부구조 분석"><meta data-vue-meta="ssr" key="og:description" name="og:description" content="undefined"><meta data-vue-meta="ssr" key="twitter:description" name="twitter:description" content="undefined"><meta data-vue-meta="ssr" key="og:type" name="og:type" content="website"><meta data-vue-meta="ssr" key="twitter:card" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" key="og:image" name="og:image" content="undefined/logo.jpg"><meta data-vue-meta="ssr" key="twitter:image" name="twitter:image" content="undefined/logo.jpg"><link data-vue-meta="ssr" rel="icon" href="data:,"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.f0886199c685a75a52fccefb5e72c094.png"><link rel="preload" href="/assets/css/0.styles.b9f2c2f4.css" as="style"><link rel="preload" href="/assets/js/app.fc6ca2d6.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--markdown-page-vue.337d2322.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.fe9494d9.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.bc04380e.js"><link rel="prefetch" href="/assets/js/search.cdc1ffc3.js"><link rel="stylesheet" href="/assets/css/0.styles.b9f2c2f4.css"><noscript data-vue-meta="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="font-sans antialiased text-ui-typo bg-ui-background"><div class="flex flex-col justify-start min-h-screen"><header class="sticky top-0 z-10 w-full border-b bg-ui-background border-ui-border"><div class="py-2 border-t-2 border-ui-primary"><div class="container"><div class="flex items-center justify-between -mx-2 sm:-mx-4"><div class="flex flex-col items-center px-2 mr-auto sm:px-4 sm:flex-row"><a href="/" title="Home" class="flex items-center text-ui-primary active"><img src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 300 82' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-d11350692290831d900d696f65124740'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-d11350692290831d900d696f65124740)' width='300' height='82' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAARCAYAAABtu6qMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAI50lEQVRYw91XeVRU1xm/b6ioMWqr2CY5p8eTnJhUPU3aJF2OtolNc9KSGKuyLwKCLAMzyCLDMsOsLA4wwAz7NgsMzMCwD/sOBkXZVJZYIUoSFY11OW0a4kJfv3tn3ghtT/o/c8477y7fffd%2bv%2b/3/e43CMFvZvImivGrwk0Ue8KIssUdKC%2b5G%2bUkdaGi9H6kErahlb/J4Wtozfz%2b%2bc0jFOmtJ%2b2Y4wbk82Eh63/ZtRnGHVsNYyHfLT3%2bAe6f77u6NgAQh9eTd3xQjW2MpmnK%2btjh/kj/3EutVWM3Jnr%2bRvc2Xj6Ax9qrJ1hrAgBfxyKUFNXEOI44brriECfNNbaTZhaeGXgWI7z0bJjb2lN/ST5gnt6FbQfMUxR%2bl2UPoBxZF1VdOkK%2bkRZvJm%2bNchCV550h7dLMfpQlbKeU0k7UZpq07a2SdaLc5C7SDnPRokbjMCoq1ZK%2b3mBCRSUaqkRdjsYmLpIxnd6AGptaSbu%2bwYyqTQ3o9uJt0h8cGv5ePxubLWnc3NKODNV1qKOr99lkyFE1oXW4Rzk70qOOZh/VwVNOc1wMNIBxOyG4ZhtJkQDjb/wOlhLbFvMsyhS2277xwZ5UzBjSzhC02sZF3DrKHvlRTN/j/TzSBqBtY1E%2blaR93F1iYaVMDv31tm9wInjUSmfu3Xuwyjl6eXkle9HsZ39FV%2bc%2bt43NzVvaDx/%2bfdW6pW%2bXEOL5G8jHJSfrt0O0vw45oqGDj6ifBB0ue8RxqaQh%2bh54XhbZ8NtT3nV01LFKH9wPddaS9CiQ967raZreYvnku2h8%2bDpzENbkyMI6ZjOFoO2FmrKR53H7wK5ksuf02Fcbb1y/twG3YW8yFsXj25zNLyp7ESK2Cbdf3fM2KihWU7wEsR0Awrpz5y5raek7%2b6TUDLvo2EQ7VV4RWafIzqNi4kV2Ytlp1vDZ8wQQAJTFSxDZJQhlJEjLT5fX4xQnm/g5FttZI6Lkuhqx848xABznKjrURdvDHEYYVusBh7wJY4uGknPPMePyOPO%2bUBfNg7hAoz/u2yNfFt4kwqvi0xh/Q6Sx5Nw2YFYX1103Bc882PGxnTSi4XVYNx/mqp1VJLa9TNgSW0LOkp1TuDtBmNQLB74Mz9UUeSbnPykNju8VSlNXXU%2bJ4hS7lf0/f%2bJMefkFrWKPPEP5El%2bUPAbgvmIbPOVX9QakwXLQYTUGAN5ldMhRDR3tW/UrPB/hrT8W7VtZAFTNj/ZspsGhWMtKR4yofeDhsluw5u6tL%2b4TYBJDaz%2bOdG%2bmeQGG6AjvilJwctIiuHWvwHOC5LyrNgVAP8dx1w2Fe5bn4jGvwyJ7/E5IlHXE8iV91ojuUijzvHC7uEz3k0RJSrg0Jf2gLDXj97F88XxqeraHQJwcUK43brfavAg2nJS0rPcZ/1LTst6DsSi1Vv%2bCXKF0OBUnfAwg77EBAFE1cSHfceQxAzAT4HAqSz63bea6l3fGnTCmYpBCjmixLtyD1NnOrGe7aEZCnfT0qeNVxDmuR3kvx6Ua92NAPz4CZ%2bcjj%2bl1UT76g8wasOkXsE2OQk7tH2B/ApDjgXASQZHsdECcQPIZHLpUJD1N1uQWlO6MT5TO8kVJRhhvUGTnCiJj%2bA8g6k3Akr44gbS1orL65XiBdBbmq6C/AEAFJMszPWDdNNjpYexKRnbuhwDAojK3aO9KAGo5FgAehWABBOWHKO4g0ffSZ0H0GwGEgTCnSmyDAbjP8zc6MFcmOHgBom0C0PoSw2rdgSETwJohrodOiW3gNtgE86444pAG9X0tMzsAzIcQfSV%2bQpzU9wvlvT8mgnxCQkCob2zZJE1Od4fDj8Dhc8CpFGgPMGc%2bnZ79DuT1AqM3AMwFAM4MGkEUGNLDB4C5yBcmzQCb3K3MagM7PS9eNJelKvj5yhR4Ew70L6DxE66rgT7pWRFsEb7G3WxnzVLwUcwMDY2FEbMDwCB5/PYOATksvjZB7d3AuRa2k44Wcer8wNkmDABoxH6oLn%2bH7QShpj/C974GkKKCjpQt4rSCJx8AuAtn8GTOk56Vcwhy/C1rzn4MVP8KKC%2bG9zQR3mL1tjSFyjs2QTw1cfGyfWGJ9ocCUfJZSVKaHsZGibNCmQycHYD0GARQSMoCqyaFklQVMOBGpjL/DasIFjEimBXt2USDup9hDgKRrMPMAMefQuSf4qsR5q%2bpswc3WCxITYSA3sOSiPp94KgrsOEWjgiMGUEEeXy26S8AzHXI83GYW4gLrA4EOwVoQxazD9glxxyvyl8hcEEQ7TkQq3Gg9OeSJHkIZhpEsxEcG08UJw8DSHHAipbRscn1DU2tm0Dpu0HY3gGbBnB8DNZfTVMo3wWgfg1rLsH4GDCgq6BYsxf603mFZa%2bRzXgBRqKSEBUHoP5tuOb%2bZGXFB6HO5dh5rAtPLddiFQ1ls7s1bWyK22a6uKVBP7oOq/%2bdmw%2bJEJqNE5trtRdIu7txaiNowW6VtNPBmhJbes3TG/btlLD2bollXR790r5GfX4rnvvokBs5T0tb53Og/ruhEHJYqeJpmao3gb4/Jfu2d2/Fe96CYqizu2%2brTekVql/oKp5pVJlG7wBMeou5%2blrbu340Nj75rJJ1/GUGeecmde3Hbz67dh1Eep7rYiRFEdaFCLdafC124/n9O6VUUVofVHiD6LWNEf9VdYFA2toBh0pWlcxu7%2bXY%2brrcM6h1RWXI5%2brIO5B9ctXV5R/EZZWqy6n/V9V6%2bQat6oNIUsCEVfsHh0Xa2v0DQPZm/Shq0p4nRh01E8VQ4ibFBhi9sBBay%2bErkONzAMgIsOJV8mFv/aqP5qd2I23OEFJDWYzblrEeVCi3lBFZonYEak%2bl8ppJIYJtmBIY/0oUfagwzVKa7v9ZJHr6ZBnnOQL6UsrcQmrhiy8tkdTqsT5QWap8ytzagdS6SvTtP75BZ0dGka7CCOVtH8KlM7bB65jvw5VHpWfmsApLNOjS1Awq1VRQTGmMRgfnUHXhp5QFgMmQTtNk3FDHlc2Muq78U2TVBWILIKE19dOrBr%2bXYnuej7U5H3CwBKUntK4Jv/8Nl9Or%2bZJ%2b%2btwAAAAASUVORK5CYII=' /%3e%3c/svg%3e" width="300" data-src="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png" data-srcset="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png 300w" data-sizes="(max-width: 300px) 100vw, 300px" class="text-ui-primary g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png" class="text-ui-primary g-image g-image--loaded" width="300"></noscript></a></div><div class="w-full px-2 sm:px-4 max-w-screen-xs"><!----></div><div class="flex items-center justify-end px-2 sm:px-4"><!----><!----><!----><div style="width:50px; height:50px; text-aling:center; line-height:50px; font-weight:700;"><a href="https://intro.msaez.io">English</a></div><button aria-label="Toggle Darkmode" title="Toggle Darkmode" class="ml-2 sm:ml-8"><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></div></div></div></div></header><main class="container relative flex flex-wrap justify-start flex-1 w-full bg-ui-background"><!----><div class="w-full pb-24"><div class="flex flex-wrap items-start justify-start"><div><a href="http://www.msaez.io/" target="_blank" rel="noopener" class="flex items-center px-1 py-1 ml-auto text-1xl font-bold leading-none text-white border rounded-lg shadow-lg bg-ui-primary border-ui-primary transition-all duration-200 ease-out transform hover:shadow-xl hover:-translate-y-1" style="position:absolute;top:5px;">
            실습하기
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 feather feather-arrow-right-circle"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></div><div class="order-1 w-full md:w-2/3"><div class="content"><h1 id="쿠버네티스-내부구조-분석"><a href="#%EC%BF%A0%EB%B2%84%EB%84%A4%ED%8B%B0%EC%8A%A4-%EB%82%B4%EB%B6%80%EA%B5%AC%EC%A1%B0-%EB%B6%84%EC%84%9D" aria-hidden="true"><span class="icon icon-link"></span></a>쿠버네티스 내부구조 분석</h1>
<h3 id="kubernetes-installation"><a href="#kubernetes-installation" aria-hidden="true"><span class="icon icon-link"></span></a>Kubernetes Installation</h3>
<h4 id="preparing-a-vm--connect"><a href="#preparing-a-vm--connect" aria-hidden="true"><span class="icon icon-link"></span></a>Preparing a VM &#x26; Connect</h4>
<ol>
<li>Prepare any Cloud VM(EC2, Agent, Compute Engine)</li>
</ol>
<ul>
<li>아마존 콘솔 접속</li>
<li>서비스 검색 > "EC2" 선택</li>
<li>실행중인스턴스 > "인스턴스 시작"</li>
<li>Ubuntu Server 20.04 LTS 선택</li>
<li>t2.micro 선택 </li>
<li>검토 및 시작</li>
<li>새 키 페어 생성 "ubuntu" > 다운로드</li>
<li>인스턴스 시작</li>
</ul>
<blockquote>
<p>보안 그룹명이 충돌나는 경우 임의의 보안그룹 명으로 변경합니다.</p>
</blockquote>
<ul>
<li>인스턴스 목록 > 생성한 인스턴스 선택 > 연결</li>
<li>받은 pem 파일을 개발 환경에 업로드 :   File Menu > UploadFiles...</li>
<li>chmod 400 ubuntu.pem</li>
</ul>
<ol>
<li>
<p>Connect to VM (here, aws EC2 Linux-AMI)</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> -i ./k8s.pem ubuntu@ec2-3-35-209-101.ap-northeast-2.compute.amazonaws.com</code></pre>
</li>
<li>
<p>Set root passwd and switching User to root</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">passwd</span> root
<span class="token function">su</span> -</code></pre>
</li>
<li>
<p>Update and upgrade Ubuntu:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">apt</span> update
<span class="token function">apt</span> upgrade -y</code></pre>
</li>
</ol>
<h3 id="install-k8s-binaries"><a href="#install-k8s-binaries" aria-hidden="true"><span class="icon icon-link"></span></a>Install K8s Binaries</h3>
<p>The next steps will prepare CRI and Software for kube setup.</p>
<ol>
<li>
<p>도커엔진을 설치:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">apt</span> <span class="token function">install</span> docker.io -y</code></pre>
</li>
<li>
<p>K8s 의 바이너리 파일을 다운 받는다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> https://storage.googleapis.com/kubernetes-release/release/v1.9.11/kubernetes-server-linux-amd64.tar.gz
<span class="token function">tar</span> -xzf kubernetes-server-linux-amd64.tar.gz</code></pre>
</li>
<li>
<p>Install the K8s binaries:</p>
<pre class="language-bash"><code class="language-bash"><span class="token builtin class-name">cd</span> kubernetes/server/bin/
<span class="token function">mv</span> kubectl kubelet kube-apiserver kube-controller-manager kube-scheduler kube-proxy /usr/bin/
<span class="token builtin class-name">cd</span></code></pre>
</li>
<li>
<p><code>kubectl</code> 이 실행되는지 확인한다:</p>
<pre class="language-bash"><code class="language-bash">kubectl</code></pre>
</li>
<li>
<p>압축파일이 더 이상 필요없으니 삭제:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">rm</span> -rf kubernetes kubernetes-server-linux-amd64.tar.gz</code></pre>
</li>
</ol>
<hr>
<h2 id="creating-the-kube"><a href="#creating-the-kube" aria-hidden="true"><span class="icon icon-link"></span></a>Creating the Kube</h2>
<h3 id="set-up-kubelet"><a href="#set-up-kubelet" aria-hidden="true"><span class="icon icon-link"></span></a>Set up kubelet</h3>
<p>다음단계는 Kubelet 의 동작을 이해한다</p>
<ol>
<li>
<p>큐블릿을 위한 디렉토리를 만든다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">mkdir</span> -p /etc/kubernetes/manifests</code></pre>
</li>
<li>
<p>큐블릿을 백그라운드(데몬)로 실행한다:</p>
<pre class="language-bash"><code class="language-bash">kubelet --pod-manifest-path /etc/kubernetes/manifests <span class="token operator">&amp;></span> /etc/kubernetes/kubelet.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>큐블릿의 상태와 기본 로그를 확인한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> kubelet
<span class="token function">head</span> /etc/kubernetes/kubelet.log</code></pre>
</li>
<li>
<p>큐블릿의 manifest directory 에 yaml 을 위치하면, 큐블릿이 해당 yaml 을 도커엔진을 통해 컨테이너를 생성해주기 때문에 그를 테스트할 yaml 을 하나 만든다.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">></span> /etc/kubernetes/manifests/kubelet-test.yaml</code></pre>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> kubelet<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> alpine
    <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"while true; do echo SuPeRgIaNt; sleep 15; done"</span><span class="token punctuation">]</span></code></pre>
<pre class="language-bash"><code class="language-bash">EOF</code></pre>
</li>
<li>
<p>파일이 생성된 직후에 도커에 해당 pod 가 생성되었는지 확인한다.:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span></code></pre>
</li>
<li>
<p>컨테이너의 로그를 확인한다</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> logs <span class="token punctuation">{</span>CONTAINER ID<span class="token punctuation">}</span></code></pre>
</li>
</ol>
<h3 id="set-up-etcd"><a href="#set-up-etcd" aria-hidden="true"><span class="icon icon-link"></span></a>Set up etcd</h3>
<p>이번단계는 etcd 에 쿠버네티스의 상태를 보존하는 것을 확인한다.</p>
<ol>
<li>
<p>etcd 와 etcdctl를 다운받고 압축해제 한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">wget</span> https://github.com/etcd-io/etcd/releases/download/v3.2.26/etcd-v3.2.26-linux-amd64.tar.gz
<span class="token function">tar</span> -xzf etcd-v3.2.26-linux-amd64.tar.gz</code></pre>
</li>
<li>
<p>etcd 와 etcdctl 바이너리를 설치한다.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">mv</span> etcd-v3.2.26-linux-amd64/etcd /usr/bin/etcd
<span class="token function">mv</span> etcd-v3.2.26-linux-amd64/etcdctl /usr/bin/etcdctl</code></pre>
</li>
<li>
<p>불필요한 리소스를 삭제한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">rm</span> -rf etcd-v3.2.26-linux-amd64 etcd-v3.2.26-linux-amd64.tar.gz</code></pre>
</li>
<li>
<p>etcd를 실행한다:</p>
<pre class="language-bash"><code class="language-bash">etcd --listen-client-urls http://0.0.0.0:2379 --advertise-client-urls http://localhost:2379 <span class="token operator">&amp;></span> /etc/kubernetes/etcd.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>etcd 가 건강하게 실행되고 있는지 다음과 같이 확인된다::</p>
<pre class="language-bash"><code class="language-bash">etcdctl cluster-health</code></pre>
</li>
<li>
<p>쿠버네티스 내에 디플로이된 모든 리소스들을 한번 확인해본다:</p>
<pre class="language-bash"><code class="language-bash">kubectl get all --all-namespaces</code></pre>
</li>
</ol>
<h3 id="set-up-kube-apiserver"><a href="#set-up-kube-apiserver" aria-hidden="true"><span class="icon icon-link"></span></a>Set up kube-apiserver</h3>
<p>이번 단계는 apiserver 가 어떻게 실행되는지 이해합니다.</p>
<ol>
<li>
<p>kube-apiserver 를 실행한다</p>
<pre class="language-bash"><code class="language-bash">kube-apiserver --etcd-servers<span class="token operator">=</span>http://localhost:2379 --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.0</span>.0.0/16 --bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0 --insecure-bind-address<span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token operator">&amp;></span> /etc/kubernetes/apiserver.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>실행상태와 시작로그를 확인한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> apiserver
<span class="token function">head</span> /etc/kubernetes/apiserver.log</code></pre>
</li>
<li>
<p>API 를 확인해보고 반응을 확인한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">curl</span> http://localhost:8080/api/v1/nodes</code></pre>
</li>
</ol>
<h2 id="kubeconfig-file-을-설정하여-kubectl-설정"><a href="#kubeconfig-file-%EC%9D%84-%EC%84%A4%EC%A0%95%ED%95%98%EC%97%AC-kubectl-%EC%84%A4%EC%A0%95" aria-hidden="true"><span class="icon icon-link"></span></a>kubeconfig File 을 설정하여 kubectl 설정</h2>
<p>이번 과정은 kubectl 을 제대로 설정해본다.</p>
<ol>
<li>
<p>kubectl 이 API server 를 제대로 바라보고 있는지 확인한다</p>
<pre class="language-bash"><code class="language-bash">kubectl cluster-info</code></pre>
</li>
<li>
<p>kubeconfig file에 API server address 가 잘 설정되었는지 확인한다</p>
<pre class="language-bash"><code class="language-bash">kubectl config set-cluster kube-from-scratch --server<span class="token operator">=</span>http://localhost:8080
kubectl config view</code></pre>
</li>
<li>
<p>우리가 접속할 apiserver 로 kubectl 의 context 를 지정한다:</p>
<pre class="language-bash"><code class="language-bash">kubectl config set-context kube-from-scratch --cluster<span class="token operator">=</span>kube-from-scratch
kubectl config view</code></pre>
</li>
<li>
<p>Use the context created earlier for kubectl:</p>
<pre class="language-bash"><code class="language-bash">kubectl config use-context kube-from-scratch
kubectl config view</code></pre>
</li>
<li>
<p>check that resources can now be seen on the cluster:</p>
<pre class="language-bash"><code class="language-bash">kubectl get all --all-namespaces
kubectl get <span class="token function">node</span></code></pre>
</li>
</ol>
<h3 id="set-up-the-new-config-for-kubelet"><a href="#set-up-the-new-config-for-kubelet" aria-hidden="true"><span class="icon icon-link"></span></a>Set up the New Config for kubelet</h3>
<p>The next steps will take the configuration created and use it to configure kubelet.</p>
<ol>
<li>
<p>Restart kubelet with a new flag pointing it to the apiserver (this step may fail once or twice, try again):</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">pkill</span> -f kubelet
kubelet --register-node --kubeconfig<span class="token operator">=</span><span class="token string">".kube/config"</span> <span class="token operator">&amp;></span> /etc/kubernetes/kubelet.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>Check its status and initial logs:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> kubelet
<span class="token function">head</span> /etc/kubernetes/kubelet.log</code></pre>
</li>
<li>
<p>Check to see that kubelet has registered as a node:</p>
<pre class="language-bash"><code class="language-bash">kubectl get <span class="token function">node</span></code></pre>
</li>
<li>
<p>Check to see the old Pod is not coming up:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">docker</span> <span class="token function">ps</span></code></pre>
</li>
<li>
<p>Check that the Pod manifest is still present:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ls</span> /etc/kubernetes/manifests</code></pre>
</li>
<li>
<p>이제 kubelet 으로 pod 를 생성해봅니다. 우리가 설치한 control plane 들이 잘 동작하는지 확인하게 됩니다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">></span> ./kube-test.yaml</code></pre>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>test
<span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  http
    <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</code></pre>
<pre class="language-bash"><code class="language-bash">EOF
kubectl create -f kube-test.yaml</code></pre>
</li>
<li>
<p>Check the Pod's status:</p>
<pre class="language-bash"><code class="language-bash">kubectl get po</code></pre>
</li>
</ol>
<h3 id="set-up-kube-scheduler"><a href="#set-up-kube-scheduler" aria-hidden="true"><span class="icon icon-link"></span></a>Set up kube-scheduler</h3>
<p>다음 단계는 scheduler 를 통해서 pod 가 생성될 수 있도록 설정합니다</p>
<ol>
<li>
<p>Scheduler를 시작합니다:</p>
<pre class="language-bash"><code class="language-bash">kube-scheduler --master<span class="token operator">=</span>http://localhost:8080/ <span class="token operator">&amp;></span> /etc/kubernetes/scheduler.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>스케쥴러의 상태와 시작로그를 확인합니다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> scheduler
<span class="token function">head</span> /etc/kubernetes/scheduler.log</code></pre>
</li>
<li>
<p>Check to see if the Pod was scheduled:</p>
<pre class="language-bash"><code class="language-bash">kubectl get po</code></pre>
</li>
<li>
<p>Delete the Pod:</p>
<pre class="language-bash"><code class="language-bash">kubectl delete po --all</code></pre>
</li>
</ol>
<h3 id="set-up-kube-controller-manager"><a href="#set-up-kube-controller-manager" aria-hidden="true"><span class="icon icon-link"></span></a>Set up kube-controller-manager</h3>
<p>다음단계는 ReplicaSet 등을 관리해주는 다양한 쿠버네티스 객체의 행위를 지원하는 controller 매니저를 설치합니다.</p>
<ol>
<li>
<p>레플리카 3개가 설정된 Deployment를 준비한다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">></span> ./replica-test.yaml</code></pre>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
<span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test
<span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test
    <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span>  http
        <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP</code></pre>
<pre class="language-bash"><code class="language-bash">EOF
kubectl create -f replica-test.yaml</code></pre>
</li>
<li>
<p>Check the Deployment's status:</p>
<pre class="language-bash"><code class="language-bash">kubectl get deploy</code></pre>
</li>
<li>
<p><code>Pending</code> 상태임을 확인한다:</p>
<pre class="language-bash"><code class="language-bash">kubectl get po</code></pre>
</li>
<li>
<p>controller-manager를 시작한다:</p>
<pre class="language-bash"><code class="language-bash">kube-controller-manager --master<span class="token operator">=</span>http://localhost:8080 <span class="token operator">&amp;></span> /etc/kubernetes/controller-manager.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>Check its status and initial logs:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> controller
<span class="token function">head</span> /etc/kubernetes/controller-manager.log</code></pre>
</li>
<li>
<p>Check the status of the Deployment:</p>
<pre class="language-bash"><code class="language-bash">kubectl get deploy</code></pre>
</li>
<li>
<p>이제 3개의 Replica 가 생성되어 각 pod 의 상태가 <code>AVAILABLE</code> 로 변경된 것을 확인한다:</p>
<pre class="language-bash"><code class="language-bash">kubectl rollout resume deploy/replica-test
kubectl rollout status deploy/replica-test</code></pre>
</li>
<li>
<p>Check the new Pods:</p>
<pre class="language-bash"><code class="language-bash">kubectl get po</code></pre>
</li>
</ol>
<h3 id="set-up-kube-proxy"><a href="#set-up-kube-proxy" aria-hidden="true"><span class="icon icon-link"></span></a>Set up kube-proxy</h3>
<p>이제 외부 트래픽을 Pod 로 전송하는 kube-proxy 를 설치하고 이들이 어떻게 동작하는지 이해한다:</p>
<ol>
<li>
<p>앞서의 <code>replica-test</code> Deployment에 대한 service 를 만들어준다:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span>EOF <span class="token operator">></span> ./service-test.yaml</code></pre>
<pre class="language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span class="token key atrule">ports</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
<span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> replica<span class="token punctuation">-</span>test</code></pre>
<pre class="language-bash"><code class="language-bash">    EOF
    kubectl create -f service-test.yaml</code></pre>
</li>
<li>
<p>Curl the service to see if any Pod is contacted:</p>
<pre class="language-bash"><code class="language-bash">kubectl get svc
<span class="token function">curl</span> <span class="token punctuation">{</span>CLUSTER IP<span class="token punctuation">}</span>:80</code></pre>
</li>
<li>
<p>Start kube-proxy:</p>
<pre class="language-bash"><code class="language-bash">kube-proxy --master<span class="token operator">=</span>http://localhost:8080/ <span class="token operator">&amp;></span> /etc/kubernetes/proxy.log <span class="token operator">&amp;</span></code></pre>
</li>
<li>
<p>Check its status and initial logs:</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">ps</span> -au <span class="token operator">|</span> <span class="token function">grep</span> proxy
<span class="token function">head</span> /etc/kubernetes/proxy.log</code></pre>
</li>
<li>
<p>Curl the Service again to see if any Pod is contacted:</p>
<pre class="language-bash"><code class="language-bash">kubectl get svc
<span class="token function">curl</span> <span class="token punctuation">{</span>CLUSTER IP<span class="token punctuation">}</span>:80</code></pre>
</li>
</ol>
</div><div class="mt-8 pt-8 lg:mt-12 lg:pt-12 border-t border-ui-border"><div><div class="flex flex-col sm:flex-row justify-between items-center"><!----><!----></div></div></div></div></div></div></main></div><!----></div>
    <script src="/assets/js/app.fc6ca2d6.js" defer></script><script src="/assets/js/page--src--templates--markdown-page-vue.337d2322.js" defer></script>
  </body>
</html>
