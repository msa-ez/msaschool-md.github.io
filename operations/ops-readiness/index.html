<!DOCTYPE html>
<html data-html-server-rendered="true" lang="en" data-vue-meta="%7B%22lang%22:%7B%22ssr%22:%22en%22%7D%7D">
  <head>
    <title>무정지 배포 실습 - msaez</title><meta name="gridsome:hash" content="f58eca0934380d084e357b0b95045cf3b386277b"><meta data-vue-meta="ssr" charset="utf-8"><meta data-vue-meta="ssr" name="generator" content="Gridsome v0.7.23"><meta data-vue-meta="ssr" key="viewport" name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"><meta data-vue-meta="ssr" key="format-detection" name="format-detection" content="telephone=no"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-argo-rollout-canary-istio/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-deploy-my-app/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-service-mesh-istio/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-anatomy-kubernetes/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-aws-setting/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-ingress-virtualhost/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-persistence-volume/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-autoscale/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-ingress/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-kubernetes/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-liveness/"><meta data-vue-meta="ssr" key="og:url" name="og:url" content="undefined/operations/ops-readiness/"><meta data-vue-meta="ssr" name="description" content="undefined"><meta data-vue-meta="ssr" key="og:title" name="og:title" content="무정지 배포 실습"><meta data-vue-meta="ssr" key="twitter:title" name="twitter:title" content="무정지 배포 실습"><meta data-vue-meta="ssr" key="og:description" name="og:description" content="undefined"><meta data-vue-meta="ssr" key="twitter:description" name="twitter:description" content="undefined"><meta data-vue-meta="ssr" key="og:type" name="og:type" content="website"><meta data-vue-meta="ssr" key="twitter:card" name="twitter:card" content="summary_large_image"><meta data-vue-meta="ssr" key="og:image" name="og:image" content="undefined/logo.jpg"><meta data-vue-meta="ssr" key="twitter:image" name="twitter:image" content="undefined/logo.jpg"><link data-vue-meta="ssr" rel="icon" href="data:,"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="16x16" href="/assets/static/favicon.ce0531f.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="32x32" href="/assets/static/favicon.ac8d93a.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="icon" type="image/png" sizes="96x96" href="/assets/static/favicon.b9532cc.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="76x76" href="/assets/static/favicon.f22e9f3.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="152x152" href="/assets/static/favicon.62d22cb.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="120x120" href="/assets/static/favicon.1539b60.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="167x167" href="/assets/static/favicon.dc0cdc5.f0886199c685a75a52fccefb5e72c094.png"><link data-vue-meta="ssr" rel="apple-touch-icon" type="image/png" sizes="180x180" href="/assets/static/favicon.7b22250.f0886199c685a75a52fccefb5e72c094.png"><link rel="preload" href="/assets/css/0.styles.b9f2c2f4.css" as="style"><link rel="preload" href="/assets/js/app.190dc09f.js" as="script"><link rel="preload" href="/assets/js/page--src--templates--markdown-page-vue.337d2322.js" as="script"><link rel="prefetch" href="/assets/js/page--src--pages--404-vue.fe9494d9.js"><link rel="prefetch" href="/assets/js/page--src--pages--index-vue.bc04380e.js"><link rel="prefetch" href="/assets/js/search.09f4e109.js"><link rel="stylesheet" href="/assets/css/0.styles.b9f2c2f4.css"><noscript data-vue-meta="ssr"><style>.g-image--loading{display:none;}</style></noscript>
  </head>
  <body >
    <div data-server-rendered="true" id="app" class="font-sans antialiased text-ui-typo bg-ui-background"><div class="flex flex-col justify-start min-h-screen"><header class="sticky top-0 z-10 w-full border-b bg-ui-background border-ui-border"><div class="py-2 border-t-2 border-ui-primary"><div class="container"><div class="flex items-center justify-between -mx-2 sm:-mx-4"><div class="flex flex-col items-center px-2 mr-auto sm:px-4 sm:flex-row"><a href="/" title="Home" class="flex items-center text-ui-primary active"><img src="data:image/svg+xml,%3csvg fill='none' viewBox='0 0 300 82' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3e%3cdefs%3e%3cfilter id='__svg-blur-d11350692290831d900d696f65124740'%3e%3cfeGaussianBlur in='SourceGraphic' stdDeviation='40'/%3e%3c/filter%3e%3c/defs%3e%3cimage x='0' y='0' filter='url(%23__svg-blur-d11350692290831d900d696f65124740)' width='300' height='82' xlink:href='data:image/png%3bbase64%2ciVBORw0KGgoAAAANSUhEUgAAAEAAAAARCAYAAABtu6qMAAAACXBIWXMAAAsTAAALEwEAmpwYAAAI50lEQVRYw91XeVRU1xm/b6ioMWqr2CY5p8eTnJhUPU3aJF2OtolNc9KSGKuyLwKCLAMzyCLDMsOsLA4wwAz7NgsMzMCwD/sOBkXZVJZYIUoSFY11OW0a4kJfv3tn3ghtT/o/c8477y7fffd%2bv%2b/3/e43CMFvZvImivGrwk0Ue8KIssUdKC%2b5G%2bUkdaGi9H6kErahlb/J4Wtozfz%2b%2bc0jFOmtJ%2b2Y4wbk82Eh63/ZtRnGHVsNYyHfLT3%2bAe6f77u6NgAQh9eTd3xQjW2MpmnK%2btjh/kj/3EutVWM3Jnr%2bRvc2Xj6Ax9qrJ1hrAgBfxyKUFNXEOI44brriECfNNbaTZhaeGXgWI7z0bJjb2lN/ST5gnt6FbQfMUxR%2bl2UPoBxZF1VdOkK%2bkRZvJm%2bNchCV550h7dLMfpQlbKeU0k7UZpq07a2SdaLc5C7SDnPRokbjMCoq1ZK%2b3mBCRSUaqkRdjsYmLpIxnd6AGptaSbu%2bwYyqTQ3o9uJt0h8cGv5ePxubLWnc3NKODNV1qKOr99lkyFE1oXW4Rzk70qOOZh/VwVNOc1wMNIBxOyG4ZhtJkQDjb/wOlhLbFvMsyhS2277xwZ5UzBjSzhC02sZF3DrKHvlRTN/j/TzSBqBtY1E%2blaR93F1iYaVMDv31tm9wInjUSmfu3Xuwyjl6eXkle9HsZ39FV%2bc%2bt43NzVvaDx/%2bfdW6pW%2bXEOL5G8jHJSfrt0O0vw45oqGDj6ifBB0ue8RxqaQh%2bh54XhbZ8NtT3nV01LFKH9wPddaS9CiQ967raZreYvnku2h8%2bDpzENbkyMI6ZjOFoO2FmrKR53H7wK5ksuf02Fcbb1y/twG3YW8yFsXj25zNLyp7ESK2Cbdf3fM2KihWU7wEsR0Awrpz5y5raek7%2b6TUDLvo2EQ7VV4RWafIzqNi4kV2Ytlp1vDZ8wQQAJTFSxDZJQhlJEjLT5fX4xQnm/g5FttZI6Lkuhqx848xABznKjrURdvDHEYYVusBh7wJY4uGknPPMePyOPO%2bUBfNg7hAoz/u2yNfFt4kwqvi0xh/Q6Sx5Nw2YFYX1103Bc882PGxnTSi4XVYNx/mqp1VJLa9TNgSW0LOkp1TuDtBmNQLB74Mz9UUeSbnPykNju8VSlNXXU%2bJ4hS7lf0/f%2bJMefkFrWKPPEP5El%2bUPAbgvmIbPOVX9QakwXLQYTUGAN5ldMhRDR3tW/UrPB/hrT8W7VtZAFTNj/ZspsGhWMtKR4yofeDhsluw5u6tL%2b4TYBJDaz%2bOdG%2bmeQGG6AjvilJwctIiuHWvwHOC5LyrNgVAP8dx1w2Fe5bn4jGvwyJ7/E5IlHXE8iV91ojuUijzvHC7uEz3k0RJSrg0Jf2gLDXj97F88XxqeraHQJwcUK43brfavAg2nJS0rPcZ/1LTst6DsSi1Vv%2bCXKF0OBUnfAwg77EBAFE1cSHfceQxAzAT4HAqSz63bea6l3fGnTCmYpBCjmixLtyD1NnOrGe7aEZCnfT0qeNVxDmuR3kvx6Ua92NAPz4CZ%2bcjj%2bl1UT76g8wasOkXsE2OQk7tH2B/ApDjgXASQZHsdECcQPIZHLpUJD1N1uQWlO6MT5TO8kVJRhhvUGTnCiJj%2bA8g6k3Akr44gbS1orL65XiBdBbmq6C/AEAFJMszPWDdNNjpYexKRnbuhwDAojK3aO9KAGo5FgAehWABBOWHKO4g0ffSZ0H0GwGEgTCnSmyDAbjP8zc6MFcmOHgBom0C0PoSw2rdgSETwJohrodOiW3gNtgE86444pAG9X0tMzsAzIcQfSV%2bQpzU9wvlvT8mgnxCQkCob2zZJE1Od4fDj8Dhc8CpFGgPMGc%2bnZ79DuT1AqM3AMwFAM4MGkEUGNLDB4C5yBcmzQCb3K3MagM7PS9eNJelKvj5yhR4Ew70L6DxE66rgT7pWRFsEb7G3WxnzVLwUcwMDY2FEbMDwCB5/PYOATksvjZB7d3AuRa2k44Wcer8wNkmDABoxH6oLn%2bH7QShpj/C974GkKKCjpQt4rSCJx8AuAtn8GTOk56Vcwhy/C1rzn4MVP8KKC%2bG9zQR3mL1tjSFyjs2QTw1cfGyfWGJ9ocCUfJZSVKaHsZGibNCmQycHYD0GARQSMoCqyaFklQVMOBGpjL/DasIFjEimBXt2USDup9hDgKRrMPMAMefQuSf4qsR5q%2bpswc3WCxITYSA3sOSiPp94KgrsOEWjgiMGUEEeXy26S8AzHXI83GYW4gLrA4EOwVoQxazD9glxxyvyl8hcEEQ7TkQq3Gg9OeSJHkIZhpEsxEcG08UJw8DSHHAipbRscn1DU2tm0Dpu0HY3gGbBnB8DNZfTVMo3wWgfg1rLsH4GDCgq6BYsxf603mFZa%2bRzXgBRqKSEBUHoP5tuOb%2bZGXFB6HO5dh5rAtPLddiFQ1ls7s1bWyK22a6uKVBP7oOq/%2bdmw%2bJEJqNE5trtRdIu7txaiNowW6VtNPBmhJbes3TG/btlLD2bollXR790r5GfX4rnvvokBs5T0tb53Og/ruhEHJYqeJpmao3gb4/Jfu2d2/Fe96CYqizu2%2brTekVql/oKp5pVJlG7wBMeou5%2blrbu340Nj75rJJ1/GUGeecmde3Hbz67dh1Eep7rYiRFEdaFCLdafC124/n9O6VUUVofVHiD6LWNEf9VdYFA2toBh0pWlcxu7%2bXY%2brrcM6h1RWXI5%2brIO5B9ctXV5R/EZZWqy6n/V9V6%2bQat6oNIUsCEVfsHh0Xa2v0DQPZm/Shq0p4nRh01E8VQ4ibFBhi9sBBay%2bErkONzAMgIsOJV8mFv/aqP5qd2I23OEFJDWYzblrEeVCi3lBFZonYEak%2bl8ppJIYJtmBIY/0oUfagwzVKa7v9ZJHr6ZBnnOQL6UsrcQmrhiy8tkdTqsT5QWap8ytzagdS6SvTtP75BZ0dGka7CCOVtH8KlM7bB65jvw5VHpWfmsApLNOjS1Awq1VRQTGmMRgfnUHXhp5QFgMmQTtNk3FDHlc2Muq78U2TVBWILIKE19dOrBr%2bXYnuej7U5H3CwBKUntK4Jv/8Nl9Or%2bZJ%2b%2btwAAAAASUVORK5CYII=' /%3e%3c/svg%3e" width="300" data-src="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png" data-srcset="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png 300w" data-sizes="(max-width: 300px) 100vw, 300px" class="text-ui-primary g-image g-image--lazy g-image--loading"><noscript><img src="/assets/static/msaschool_logo.6b65613.de89ab5f2636ecdd884e540e6ce8a652.png" class="text-ui-primary g-image g-image--loaded" width="300"></noscript></a></div><div class="w-full px-2 sm:px-4 max-w-screen-xs"><!----></div><div class="flex items-center justify-end px-2 sm:px-4"><!----><!----><!----><div style="width:50px; height:50px; text-aling:center; line-height:50px; font-weight:700;"><a href="https://intro.msaez.io">English</a></div><button aria-label="Toggle Darkmode" title="Toggle Darkmode" class="ml-2 sm:ml-8"><svg xmlns="http://www.w3.org/2000/svg" width="1.5em" height="1.5em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></button></div></div></div></div></header><main class="container relative flex flex-wrap justify-start flex-1 w-full bg-ui-background"><!----><div class="w-full pb-24"><div class="flex flex-wrap items-start justify-start"><div><a href="http://www.msaez.io/" target="_blank" rel="noopener" class="flex items-center px-1 py-1 ml-auto text-1xl font-bold leading-none text-white border rounded-lg shadow-lg bg-ui-primary border-ui-primary transition-all duration-200 ease-out transform hover:shadow-xl hover:-translate-y-1" style="position:absolute;top:5px;">
            실습하기
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-1 feather feather-arrow-right-circle"><circle cx="12" cy="12" r="10"></circle><polyline points="12 16 16 12 12 8"></polyline><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></div><div class="order-1 w-full md:w-2/3"><div class="content"><h1 id="무정지-배포-실습"><a href="#%EB%AC%B4%EC%A0%95%EC%A7%80-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5" aria-hidden="true"><span class="icon icon-link"></span></a>무정지 배포 실습</h1>
<h2 id="무정지-배포-실습-readinessprobe-설정-제로-다운타임"><a href="#%EB%AC%B4%EC%A0%95%EC%A7%80-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5-readinessprobe-%EC%84%A4%EC%A0%95-%EC%A0%9C%EB%A1%9C-%EB%8B%A4%EC%9A%B4%ED%83%80%EC%9E%84" aria-hidden="true"><span class="icon icon-link"></span></a>무정지 배포 실습 (readinessProbe 설정, 제로 다운타임)</h2>
<p>이번 시간은 클러스터에 배포시 다운타임이 존재하는지 실습을 한다. 클러스터에 배포를 할때 readinessProbe 설정이 없으면 다운타임이 존재 하게 된다. 이는 쿠버네티스에서 Ramped 배포 방식으로 무정지 배포를 시도 하지만, 서비스가 기동하는 시간이 있기 때문에, 기동 시간동안 장애가 발생 할 수 있다.  </p>
<p>배포시 다운타임의 존재 여부를 확인하기 위하여, siege 라는 부하 테스트 툴을 사용한다.<br>
배포시작전에 부하테스트 툴을 실행하고, 배포 완료시 종료한 후, 결과값인 Availability 를 체크 하여 어느정도의 실패가 있었는지를 확인한다.</p>
<h3 id="선행과정"><a href="#%EC%84%A0%ED%96%89%EA%B3%BC%EC%A0%95" aria-hidden="true"><span class="icon icon-link"></span></a>선행과정</h3>
<ul>
<li>Kafka 가 설치되어있어야 한다:
설치가 필요한 경우,
<a href="https://labs.msaez.io/#/courses/cna-full/running@sds-1012/ops-utility" target="_blank" rel="noopener noreferrer">https://labs.msaez.io/#/courses/cna-full/running@sds-1012/ops-utility</a>
를 참고하여 설치한다.</li>
<li>주문서비스를 배포한다:</li>
</ul>
<pre class="language-text"><code class="language-text">apiVersion: apps/v1
kind: Deployment
metadata:
  name: order
  labels:
    app: order
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order
  template:
    metadata:
      labels:
        app: order
    spec:
      containers:
        - name: order
          image: jinyoung/order:stable
          ports:
            - containerPort: 8080</code></pre>
<p>위의 파일을 deployment.yaml 파일로 만든후 저장한다.
저장한 파일을 배포한다:</p>
<pre class="language-text"><code class="language-text">kubectl apply -f deployment.yaml</code></pre>
<p>서비스 객체를 위한 yaml도 만든다:</p>
<pre class="language-text"><code class="language-text">apiVersion: &quot;v1&quot;
kind: &quot;Service&quot;
metadata: 
  name: &quot;order&quot;
  labels: 
    app: &quot;order&quot;
spec: 
  ports: 
    - 
      port: 8080
      targetPort: 8080
  selector: 
    app: &quot;order&quot;
  type: &quot;ClusterIP&quot;</code></pre>
<p>를 만든후</p>
<pre class="language-text"><code class="language-text">kubectl apply -f service.yaml</code></pre>
<p>로 서비스를 한다.</p>
<ul>
<li>
<p>부하 테스트 Pod 설치
- 아래 스크립트를 terminal 에 복사하여 siege 라는 Pod 를 생성한다.</p>
<pre class="language-text"><code class="language-text">	```</code></pre>
<p>  kubectl apply -f - &#x3C;&#x3C;EOF
apiVersion: v1
kind: Pod
metadata:
name: siege
spec:
containers:
- name: siege
image: apexacme/siege-nginx
EOF</p>
<pre class="language-text"><code class="language-text">	```
	- 생성된 siege Pod 안쪽에서 정상작동 확인
	```
	kubectl exec -it siege -- /bin/bash
	siege -c1 -t2S -v http://order:8080/orders
	exit
	```</code></pre>
</li>
</ul>
<h3 id="1-readinessprobe-가-없는-상태에서-배포-진행"><a href="#1-readinessprobe-%EA%B0%80-%EC%97%86%EB%8A%94-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C-%EB%B0%B0%ED%8F%AC-%EC%A7%84%ED%96%89" aria-hidden="true"><span class="icon icon-link"></span></a>1. readinessProbe 가 없는 상태에서 배포 진행</h3>
<p>1.1 새 버전을 배포할 준비를 한다:
deployment.yaml 의 이미지 정보를 아래와 같이 변경한 후:</p>
<pre class="language-text"><code class="language-text">image: jinyoung/order:canary</code></pre>
<p>1.2 새로운 터미널을 열어서 충분한 시간만큼 부하를 준다.</p>
<pre class="language-text"><code class="language-text">kubectl exec -it siege -- /bin/bash
siege -c1 -t60S -v http://order:8080/orders --delay=1S</code></pre>
<p>1.3. 배포를 반영한다:</p>
<pre class="language-text"><code class="language-text">kubectl apply -f deployment.yaml</code></pre>
<p>1.5 siege 로그를 보면서 배포시 정지시간이 발생한것을 확인한다.</p>
<pre class="language-text"><code class="language-text">Transactions:                     82 hits
Availability:                  70.09 %
Elapsed time:                  59.11 secs</code></pre>
<h3 id="2-readinessprobe-를-설정하고-배포-진행"><a href="#2-readinessprobe-%EB%A5%BC-%EC%84%A4%EC%A0%95%ED%95%98%EA%B3%A0-%EB%B0%B0%ED%8F%AC-%EC%A7%84%ED%96%89" aria-hidden="true"><span class="icon icon-link"></span></a>2. readinessProbe 를 설정하고 배포 진행</h3>
<p>2.1 아래와 같이 readiness 설정을 한다:</p>
<pre class="language-text"><code class="language-text">    spec:
      containers:
        - name: order
				  ...
          readinessProbe:    # 이부분!
            httpGet:
              path: &#39;/orders&#39;
              port: 8080
            initialDelaySeconds: 10
            timeoutSeconds: 2
            periodSeconds: 5
            failureThreshold: 10</code></pre>
<p>2.2. image 명도 변경한다:</p>
<pre class="language-text"><code class="language-text">				image: jinyoung/order:stable</code></pre>
<p>2.2 siege 터미널을 열어서 충분한 시간만큼 부하를 준다.</p>
<pre class="language-text"><code class="language-text">kubectl exec -it siege -- /bin/bash
siege -c1 -t60S -v http://order:8080/orders --delay=1S</code></pre>
<p>2.3 배포한다</p>
<ul>
<li>kubectl apply -f deployment.yml</li>
</ul>
<p>2.5 siege 로그를 보면서 배포시 무정지로 배포된 것을 확인한다.</p>
<pre class="language-text"><code class="language-text">Transactions:                    112 hits
Availability:                 100.00 %
Elapsed time:                  59.58 secs</code></pre>
<blockquote>
<p>주의점: siege 테스트를 걸어놓은 후 배포해야 정확한 테스트가 이루어집니다. </p>
</blockquote>
<h3 id="상세설명"><a href="#%EC%83%81%EC%84%B8%EC%84%A4%EB%AA%85" aria-hidden="true"><span class="icon icon-link"></span></a>상세설명</h3>
<iframe width="100%" height="100%" src="https://www.youtube.com/embed/n_A59SwsDJ0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
</div><div class="mt-8 pt-8 lg:mt-12 lg:pt-12 border-t border-ui-border"><div><div class="flex flex-col sm:flex-row justify-between items-center"><!----><!----></div></div></div></div></div></div></main></div><!----></div>
    <script>window.__INITIAL_STATE__={"data":{"markdownPage":{"id":"0dce85dd4a46fd82a5cd8377d73710da","title":"무정지 배포 실습","description":"","path":"\u002Foperations\u002Fops-readiness\u002F","timeToRead":2,"content":"\u003Ch1 id=\"무정지-배포-실습\"\u003E\u003Ca href=\"#%EB%AC%B4%EC%A0%95%EC%A7%80-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E무정지 배포 실습\u003C\u002Fh1\u003E\n\u003Ch2 id=\"무정지-배포-실습-readinessprobe-설정-제로-다운타임\"\u003E\u003Ca href=\"#%EB%AC%B4%EC%A0%95%EC%A7%80-%EB%B0%B0%ED%8F%AC-%EC%8B%A4%EC%8A%B5-readinessprobe-%EC%84%A4%EC%A0%95-%EC%A0%9C%EB%A1%9C-%EB%8B%A4%EC%9A%B4%ED%83%80%EC%9E%84\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E무정지 배포 실습 (readinessProbe 설정, 제로 다운타임)\u003C\u002Fh2\u003E\n\u003Cp\u003E이번 시간은 클러스터에 배포시 다운타임이 존재하는지 실습을 한다. 클러스터에 배포를 할때 readinessProbe 설정이 없으면 다운타임이 존재 하게 된다. 이는 쿠버네티스에서 Ramped 배포 방식으로 무정지 배포를 시도 하지만, 서비스가 기동하는 시간이 있기 때문에, 기동 시간동안 장애가 발생 할 수 있다.  \u003C\u002Fp\u003E\n\u003Cp\u003E배포시 다운타임의 존재 여부를 확인하기 위하여, siege 라는 부하 테스트 툴을 사용한다.\u003Cbr\u003E\n배포시작전에 부하테스트 툴을 실행하고, 배포 완료시 종료한 후, 결과값인 Availability 를 체크 하여 어느정도의 실패가 있었는지를 확인한다.\u003C\u002Fp\u003E\n\u003Ch3 id=\"선행과정\"\u003E\u003Ca href=\"#%EC%84%A0%ED%96%89%EA%B3%BC%EC%A0%95\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E선행과정\u003C\u002Fh3\u003E\n\u003Cul\u003E\n\u003Cli\u003EKafka 가 설치되어있어야 한다:\n설치가 필요한 경우,\n\u003Ca href=\"https:\u002F\u002Flabs.msaez.io\u002F#\u002Fcourses\u002Fcna-full\u002Frunning@sds-1012\u002Fops-utility\" target=\"_blank\" rel=\"noopener noreferrer\"\u003Ehttps:\u002F\u002Flabs.msaez.io\u002F#\u002Fcourses\u002Fcna-full\u002Frunning@sds-1012\u002Fops-utility\u003C\u002Fa\u003E\n를 참고하여 설치한다.\u003C\u002Fli\u003E\n\u003Cli\u003E주문서비스를 배포한다:\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003EapiVersion: apps\u002Fv1\nkind: Deployment\nmetadata:\n  name: order\n  labels:\n    app: order\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: order\n  template:\n    metadata:\n      labels:\n        app: order\n    spec:\n      containers:\n        - name: order\n          image: jinyoung\u002Forder:stable\n          ports:\n            - containerPort: 8080\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E위의 파일을 deployment.yaml 파일로 만든후 저장한다.\n저장한 파일을 배포한다:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ekubectl apply -f deployment.yaml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E서비스 객체를 위한 yaml도 만든다:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003EapiVersion: &quot;v1&quot;\nkind: &quot;Service&quot;\nmetadata: \n  name: &quot;order&quot;\n  labels: \n    app: &quot;order&quot;\nspec: \n  ports: \n    - \n      port: 8080\n      targetPort: 8080\n  selector: \n    app: &quot;order&quot;\n  type: &quot;ClusterIP&quot;\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E를 만든후\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ekubectl apply -f service.yaml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E로 서비스를 한다.\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Cp\u003E부하 테스트 Pod 설치\n- 아래 스크립트를 terminal 에 복사하여 siege 라는 Pod 를 생성한다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E\t```\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E  kubectl apply -f - &#x3C;&#x3C;EOF\napiVersion: v1\nkind: Pod\nmetadata:\nname: siege\nspec:\ncontainers:\n- name: siege\nimage: apexacme\u002Fsiege-nginx\nEOF\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E\t```\n\t- 생성된 siege Pod 안쪽에서 정상작동 확인\n\t```\n\tkubectl exec -it siege -- \u002Fbin\u002Fbash\n\tsiege -c1 -t2S -v http:\u002F\u002Forder:8080\u002Forders\n\texit\n\t```\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Ch3 id=\"1-readinessprobe-가-없는-상태에서-배포-진행\"\u003E\u003Ca href=\"#1-readinessprobe-%EA%B0%80-%EC%97%86%EB%8A%94-%EC%83%81%ED%83%9C%EC%97%90%EC%84%9C-%EB%B0%B0%ED%8F%AC-%EC%A7%84%ED%96%89\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E1. readinessProbe 가 없는 상태에서 배포 진행\u003C\u002Fh3\u003E\n\u003Cp\u003E1.1 새 버전을 배포할 준비를 한다:\ndeployment.yaml 의 이미지 정보를 아래와 같이 변경한 후:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Eimage: jinyoung\u002Forder:canary\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E1.2 새로운 터미널을 열어서 충분한 시간만큼 부하를 준다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ekubectl exec -it siege -- \u002Fbin\u002Fbash\nsiege -c1 -t60S -v http:\u002F\u002Forder:8080\u002Forders --delay=1S\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E1.3. 배포를 반영한다:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ekubectl apply -f deployment.yaml\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E1.5 siege 로그를 보면서 배포시 정지시간이 발생한것을 확인한다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003ETransactions:                     82 hits\nAvailability:                  70.09 %\nElapsed time:                  59.11 secs\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 id=\"2-readinessprobe-를-설정하고-배포-진행\"\u003E\u003Ca href=\"#2-readinessprobe-%EB%A5%BC-%EC%84%A4%EC%A0%95%ED%95%98%EA%B3%A0-%EB%B0%B0%ED%8F%AC-%EC%A7%84%ED%96%89\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E2. readinessProbe 를 설정하고 배포 진행\u003C\u002Fh3\u003E\n\u003Cp\u003E2.1 아래와 같이 readiness 설정을 한다:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E    spec:\n      containers:\n        - name: order\n\t\t\t\t  ...\n          readinessProbe:    # 이부분!\n            httpGet:\n              path: &#39;\u002Forders&#39;\n              port: 8080\n            initialDelaySeconds: 10\n            timeoutSeconds: 2\n            periodSeconds: 5\n            failureThreshold: 10\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E2.2. image 명도 변경한다:\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003E\t\t\t\timage: jinyoung\u002Forder:stable\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E2.2 siege 터미널을 열어서 충분한 시간만큼 부하를 준다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003Ekubectl exec -it siege -- \u002Fbin\u002Fbash\nsiege -c1 -t60S -v http:\u002F\u002Forder:8080\u002Forders --delay=1S\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E2.3 배포한다\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003Ekubectl apply -f deployment.yml\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003E2.5 siege 로그를 보면서 배포시 무정지로 배포된 것을 확인한다.\u003C\u002Fp\u003E\n\u003Cpre class=\"language-text\"\u003E\u003Ccode class=\"language-text\"\u003ETransactions:                    112 hits\nAvailability:                 100.00 %\nElapsed time:                  59.58 secs\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003E주의점: siege 테스트를 걸어놓은 후 배포해야 정확한 테스트가 이루어집니다. \u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Ch3 id=\"상세설명\"\u003E\u003Ca href=\"#%EC%83%81%EC%84%B8%EC%84%A4%EB%AA%85\" aria-hidden=\"true\"\u003E\u003Cspan class=\"icon icon-link\"\u003E\u003C\u002Fspan\u003E\u003C\u002Fa\u003E상세설명\u003C\u002Fh3\u003E\n\u003Ciframe width=\"100%\" height=\"100%\" src=\"https:\u002F\u002Fwww.youtube.com\u002Fembed\u002Fn_A59SwsDJ0\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen\u003E\u003C\u002Fiframe\u003E\n","sidebar":"business","next":"","prev":"","headings":[{"depth":1,"value":"무정지 배포 실습","anchor":"#무정지-배포-실습"},{"depth":2,"value":"무정지 배포 실습 (readinessProbe 설정, 제로 다운타임)","anchor":"#무정지-배포-실습-readinessprobe-설정-제로-다운타임"},{"depth":3,"value":"선행과정","anchor":"#선행과정"},{"depth":3,"value":"1. readinessProbe 가 없는 상태에서 배포 진행","anchor":"#1-readinessprobe-가-없는-상태에서-배포-진행"},{"depth":3,"value":"2. readinessProbe 를 설정하고 배포 진행","anchor":"#2-readinessprobe-를-설정하고-배포-진행"},{"depth":3,"value":"상세설명","anchor":"#상세설명"}]},"allMarkdownPage":{"edges":[{"node":{"path":"\u002Foperations\u002Fops-service-mesh-istio\u002F","title":"[Service Mesh] Istio"}},{"node":{"path":"\u002Foperations\u002Fops-utility\u002F","title":"쿠버네티스 유틸리티"}},{"node":{"path":"\u002Foperations\u002Fops-readiness\u002F","title":"무정지 배포 실습"}},{"node":{"path":"\u002Foperations\u002Fops-persistence-volume\u002F","title":"파일시스템 (볼륨) 연결과 데이터베이스 설정"}},{"node":{"path":"\u002Fbusiness\u002Fzero-based-cna\u002F","title":"[설계] ES모델 기반 Inner 아키텍처 이해"}},{"node":{"path":"\u002Fdevelopment\u002Fdp-graphql\u002F","title":"[구현] 데이터프로젝션-GraphQL"}},{"node":{"path":"\u002Foperations\u002Fops-liveness\u002F","title":"셀프힐링 실습"}},{"node":{"path":"\u002Foperations\u002Fops-ingress-virtualhost\u002F","title":"Ingress - Virtual Host based"}},{"node":{"path":"\u002Foperations\u002Fops-ingress\u002F","title":"Ingress 를 통한 진입점 통일 - Path-based routing"}},{"node":{"path":"\u002Foperations\u002Fops-kubernetes\u002F","title":"Kubernetes Basic Commands"}},{"node":{"path":"\u002Foperations\u002Fops-deploy-my-app\u002F","title":"애플리케이션 패키징,도커라이징,클러스터 배포"}},{"node":{"path":"\u002Foperations\u002Fops-argo-rollout-canary-istio\u002F","title":"[GitOps] Argo Rollout 와 Istio 를 통한 카나리 배포"}},{"node":{"path":"\u002Foperations\u002Fops-autoscale\u002F","title":"Pod Auto Scaling"}},{"node":{"path":"\u002Foperations\u002Fops-aws-setting\u002F","title":"AWS Cloud Setup(EKS, ECR 설정)"}},{"node":{"path":"\u002Foperations\u002Fops-anatomy-kubernetes\u002F","title":"쿠버네티스 내부구조 분석"}},{"node":{"path":"\u002Foperations\u002Fmsa-logging\u002F","title":"MSA 로깅 with EFK Stack"}},{"node":{"path":"\u002Foperations\u002Fistio-traffic\u002F","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅"}},{"node":{"path":"\u002Foperations\u002Fk8s-monitoring\u002F","title":"MSA 모니터링 with installing Grafana"}},{"node":{"path":"\u002Foperations\u002Fistio-resiliency-part2\u002F","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part2 - 서킷브레이커"}},{"node":{"path":"\u002Foperations\u002Fistio-resiliency-part1\u002F","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part1 - 타임아웃\u002F재시도"}},{"node":{"path":"\u002Foperations\u002Fistio-msa-telemetry\u002F","title":"[Service Mesh] MSA 모니터링 w\u002F Istio addon Grafana"}},{"node":{"path":"\u002Foperations\u002Fazure\u002F","title":"Azure Cloud Setup (AKS, ACR 설정)"}},{"node":{"path":"\u002Foperations\u002Fend-to-end\u002F","title":"12번가 전체 마이크로서비스의 배포"}},{"node":{"path":"\u002Foperations\u002Fgitops-argo-cd\u002F","title":"[GitOps] Argo CD 를 통한 카나리 배포"}},{"node":{"path":"\u002Fdevelopment\u002Fops-docker\u002F","title":"[빌드] Docker Image Build & Push"}},{"node":{"path":"\u002Fdevelopment\u002Fkeycloak-oauth2-3\u002F","title":"Fine grained RBAC w\u002F Resource Server"}},{"node":{"path":"\u002Fdevelopment\u002Foauth2withkeycloak\u002F","title":"JWT토큰 기반 인증인가 w\u002F Keycloak Authz-svr"}},{"node":{"path":"\u002Fdevelopment\u002Foauth2\u002F","title":"JWT토큰 기반 인증인가 w\u002F Spring Authz-svr"}},{"node":{"path":"\u002Fdevelopment\u002Fmonolith2misvc\u002F","title":"[구현] Req\u002FRes 방식의 MSA 연동"}},{"node":{"path":"\u002Fdevelopment\u002Fkeycloak-oauth2-1\u002F","title":"Keycloak Authorization 서버 설정"}},{"node":{"path":"\u002Fdevelopment\u002Fkafka-retry-dlq\u002F","title":"Retry & Dead Letter Queue"}},{"node":{"path":"\u002Fdevelopment\u002Fkafka-scaling\u002F","title":"Kafka 스케일링"}},{"node":{"path":"\u002Fdevelopment\u002Fkeycloak-oauth2-2\u002F","title":"Keycloak OIDC w\u002F OAuth2 Client"}},{"node":{"path":"\u002Fdevelopment\u002Fkafka-base\u002F","title":"[pre-lab] 카프카 연습"}},{"node":{"path":"\u002Fdevelopment\u002Fgateway\u002F","title":"[구현] 게이트웨이를 통한 진입점 통일"}},{"node":{"path":"\u002Fdevelopment\u002Ffront-end\u002F","title":"프론트엔드 개발"}},{"node":{"path":"\u002Fdevelopment\u002Fkafka-manual-commit\u002F","title":"Kafka 수동커밋"}},{"node":{"path":"\u002Fdevelopment\u002Fdp-cqrs\u002F","title":"[구현] 데이터프로젝션-CQRS"}},{"node":{"path":"\u002Fdevelopment\u002Fdp-composite-svc\u002F","title":"[구현] 데이터프로젝션-컴포지트서비스"}},{"node":{"path":"\u002Fdevelopment\u002Fcqrs-modeling\u002F","title":"[pre-lab] CQRS 샘플 모델링"}},{"node":{"path":"\u002Fdevelopment\u002Fcontract-test\u002F","title":"[테스트] Consumer Driven Test 기반 Contract Test"}},{"node":{"path":"\u002Fdevelopment\u002Fcna-pubsub2\u002F","title":"[구현] Pub\u002FSub - Compensation and Correlation"}},{"node":{"path":"\u002Fdevelopment\u002Fcna-start\u002F","title":"[구현] 마이크로서비스의 실행"}},{"node":{"path":"\u002Fdevelopment\u002Fcna-pubsub\u002F","title":"[구현] Pub\u002FSub 방식의 MSA 연동"}},{"node":{"path":"\u002Fdevelopment\u002Fcircuitbreaker\u002F","title":"[구현] Req\u002FRes 방식에서 장애전파 차단(서킷브레이커 패턴)"}},{"node":{"path":"\u002Fdevelopment\u002Fcapstone-project-1\u002F","title":"[Capstone Prj.] Simple Mall - Scenario\u002FModeling"}},{"node":{"path":"\u002Fdevelopment\u002Fcapstone-project-2\u002F","title":"[Capstone Prj.] Simple Mall - Implementation"}},{"node":{"path":"\u002Fbusiness\u002Fddd-google-drive\u002F","title":"[이벤트스토밍] DDD 구글 드라이브 예제"}},{"node":{"path":"\u002Fdevelopment\u002Fadvanced-connect\u002F","title":"Kafka Connect"}},{"node":{"path":"\u002Fbusiness\u002F","title":"[분석] DDD 이벤트의 도출 - 12번가 쇼핑몰"}},{"node":{"path":"\u002Fbusiness\u002Fdesign-to-code\u002F","title":"[설계] ES모델기반 템플릿 코드 분석"}},{"node":{"path":"\u002Fbusiness\u002Feventstorming-fooddelivery\u002F","title":"[이벤트스토밍] DDD Food Delivery 예제"}},{"node":{"path":"\u002Fbusiness\u002Fcollaborative-eventstorming\u002F","title":"[이벤트스토밍] Collaborative Eventstorming"}}]}},"context":{}};(function(){var s;(s=document.currentScript||document.scripts[document.scripts.length-1]).parentNode.removeChild(s);}());</script><script src="/assets/js/app.190dc09f.js" defer></script><script src="/assets/js/page--src--templates--markdown-page-vue.337d2322.js" defer></script>
  </body>
</html>
