{"hash":"49f02bf9a1ddbf017efeb189302ebd145a2955d8","data":{"markdownPage":{"id":"571ab8a64d93cb63cf75352c079a9e86","title":"[Service Mesh] Istio","description":"","path":"/operations/ops-service-mesh-istio/","timeToRead":8,"content":"<h1 id=\"service-mesh-istio\"><a href=\"#service-mesh-istio\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>[Service Mesh] Istio</h1>\n<h1 id=\"service-mesh-istio-1\"><a href=\"#service-mesh-istio-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>[Service Mesh] Istio</h1>\n<h2 id=\"download--install-istio\"><a href=\"#download--install-istio\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Download &#x26; Install Istio</h2>\n<ol>\n<li>다운로드 후, 압축을 해제한다</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">curl -L https://istio.io/downloadIstio | ISTIO_VERSION=1.14.5 TARGET_ARCH=x86_64 sh -</code></pre>\n<ol>\n<li>Istio 패키지 폴더로 이동시킨다 </li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">cd istio-1.14.5</code></pre>\n<p>   해당 디렉토리에는 다음의 내용을 포함하고 있다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">- 샘플애플리케이션: `samples/`\n- `istioctl` 클라이언트 툴은\n  `bin/` 디렉토리에 포함되어있다.</code></pre>\n<ol>\n<li><code>istioctl</code> 클라이언트를 PATH에 잡아준다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ export PATH=$PWD/bin:$PATH</code></pre>\n<h2 id=\"install-istio\"><a href=\"#install-istio\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Install Istio</h2>\n<ol>\n<li>기본적인 구성인 <code>demo</code> 를 기반으로 설치한다. </li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ istioctl install --set profile=demo --set hub=gcr.io/istio-release\n    ✔ Istio core installed\n    ✔ Istiod installed\n    ✔ Egress gateways installed\n    ✔ Ingress gateways installed\n    ✔ Installation complete</code></pre>\n<ol>\n<li>Envoy 사이드카를 생성하는 Pod 들에 자동적으로 주입하게 하기 위해 다음의 설정을 추가한다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl label namespace default istio-injection=enabled\n    namespace/default labeled</code></pre>\n<h2 id=\"deploy-the-sample-application-bookinfo\"><a href=\"#deploy-the-sample-application-bookinfo\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Deploy the sample application bookinfo</h2>\n<ol>\n<li><code>Bookinfo</code> 샘플 애플리케이션을 설치한다</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml\n\nservice/details created\nserviceaccount/bookinfo-details created\ndeployment.apps/details-v1 created\nservice/ratings created\nserviceaccount/bookinfo-ratings created\ndeployment.apps/ratings-v1 created\nservice/reviews created\nserviceaccount/bookinfo-reviews created\ndeployment.apps/reviews-v1 created\ndeployment.apps/reviews-v2 created\ndeployment.apps/reviews-v3 created\nservice/productpage created\nserviceaccount/bookinfo-productpage created\ndeployment.apps/productpage-v1 created</code></pre>\n<ol>\n<li>애플리케이션이 시작되고 각 Pod들이 준비상태가 된다. Istio Sidecar들이 같이 배포되었을 것이다.</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl get services\n\nNAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE\ndetails       ClusterIP   10.0.0.212      &lt;none&gt;        9080/TCP   29s\nkubernetes    ClusterIP   10.0.0.1        &lt;none&gt;        443/TCP    25m\nproductpage   ClusterIP   10.0.0.57       &lt;none&gt;        9080/TCP   28s\nratings       ClusterIP   10.0.0.33       &lt;none&gt;        9080/TCP   29s\nreviews       ClusterIP   10.0.0.28       &lt;none&gt;        9080/TCP   29s</code></pre>\n<p>  그리고 다음과 같이 확인한다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl get pods\n\nNAME                              READY   STATUS    RESTARTS   AGE\ndetails-v1-558b8b4b76-2llld       2/2     Running   0          2m41s\nproductpage-v1-6987489c74-lpkgl   2/2     Running   0          2m40s\nratings-v1-7dc98c7588-vzftc       2/2     Running   0          2m41s\nreviews-v1-7f99cc4496-gdxfn       2/2     Running   0          2m41s\nreviews-v2-7d79d5bd5d-8zzqd       2/2     Running   0          2m41s\nreviews-v3-7dbcdcbc56-m8dph       2/2     Running   0          2m41s</code></pre>\n<blockquote>\n<p>  모든 Pod 가 <code>2/2</code>로 표시될때까지 기다린다\n모든 상태가 <code>Running</code> 이 될때까지 기다린다</p>\n</blockquote>\n<ol>\n<li>모든것이 제대로 된 후에는 다음의 주소로 접속하여 웹 페이지 HTML 콘텐츠 내용을 확인할 수 있어야 한다.</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl exec &quot;$(kubectl get pod -l app=ratings -o jsonpath=&#39;{.items[0].metadata.name}&#39;)&quot; -c ratings -- curl -sS productpage:9080/productpage | grep -o &quot;&lt;title&gt;.*&lt;/title&gt;&quot;\n    &lt;title&gt;Simple Bookstore App&lt;/title&gt;</code></pre>\n<h2 id=\"open-the-application-to-outside-traffic\"><a href=\"#open-the-application-to-outside-traffic\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Open the application to outside traffic</h2>\n<p>애플리케이션이 잘 디플로이 되었지만 외부에서는 접근이 되지 않은 상태이다. 외부접속이 가능하게 하기위해서는 Istio의 Ingress Gateway를 설정해야 한다. </p>\n<ol>\n<li>애플리케이션들을 Istio Gateway 에 묶기위한 설정들을 배포한다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml\n    gateway.networking.istio.io/bookinfo-gateway created\n    virtualservice.networking.istio.io/bookinfo created</code></pre>\n<ol>\n<li>발생한 문제가 없는지 확인한다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ istioctl analyze\n✔ No validation issues found when analyzing namespace: default.</code></pre>\n<h3 id=\"determining-the-ingress-ip-and-ports\"><a href=\"#determining-the-ingress-ip-and-ports\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Determining the ingress IP and ports</h3>\n<p>다음의 환경 변수를 인그레스의 접속 주소를 얻어와 설정한다:<code>INGRESS_HOST</code> 와 <code>INGRESS_PORT</code> </p>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl get svc istio-ingressgateway -n istio-system\nNAME                   TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                                      AGE\nistio-ingressgateway   LoadBalancer   172.21.109.129   130.211.10.121  80:31380/TCP,443:31390/TCP,31400:31400/TCP   17h</code></pre>\n<p>어느정도 기다렸을때, <code>EXTERNAL-IP</code> 값이 설정되었다면 외부 로드밸런서 설정이 잘 된것이다. 만약 설정값이 기다려도 나타나지 않으면, 외부 ㄹ드밸런서가 없는 경우이다.</p>\n<p>인그레스의 IP 와 Port 번호를 가져온다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.status.loadBalancer.ingress[0].ip}&#39;)\n$ export INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&quot;http2&quot;)].port}&#39;)\n$ export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.spec.ports[?(@.name==&quot;https&quot;)].port}&#39;)</code></pre>\n<blockquote>\n<p>AWS와 같은 특정한 환경에서는 IP address 대신 host명을 넘겨주는 경우가 있다.\n이런 경우는 호스트명을 가져오도록 하는 명령으로 대치하여 설정한다:</p>\n</blockquote>\n<pre class=\"language-text\"><code class=\"language-text\">$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath=&#39;{.status.loadBalancer.ingress[0].hostname}&#39;)</code></pre>\n<ol>\n<li>그런다음 다음의 환경변수에 Gateway URL을 생성할 수 있다: <code>GATEWAY_URL</code>:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ export GATEWAY_URL=$INGRESS_HOST:$INGRESS_PORT</code></pre>\n<ol>\n<li>환경변수에 IP address 와 port 가 잘 설정되었는지 확인한다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ echo &quot;$GATEWAY_URL&quot;\n192.168.99.100:32194</code></pre>\n<h3 id=\"verify-external-access\"><a href=\"#verify-external-access\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Verify external access</h3>\n<p>외부에서의 접속이 문제 없는지 확인한다.</p>\n<ol>\n<li>다음의 명령을 입력하여 얻어진 url 로 브라우저를 접속하여 Bookinfo application이 잘 동작하는지 확인한다.</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ echo &quot;http://$GATEWAY_URL/productpage&quot;</code></pre>\n<p>Bookinfo product page 를 여러번 리프래스 해본다.</p>\n<h2 id=\"동적-트래픽-제어-테스트\"><a href=\"#%EB%8F%99%EC%A0%81-%ED%8A%B8%EB%9E%98%ED%94%BD-%EC%A0%9C%EC%96%B4-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>동적 트래픽 제어 테스트</h2>\n<p>Review 서비스의 종류별 유입을 동적으로 변경하여 Canary 배포등의 시나리오에 적용하는 예시.</p>\n<p>VirtualService 를 먼저 배포한다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-80-20.yaml </code></pre>\n<p>DestinationRule 을 배포한다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f samples/bookinfo/networking/destination-rule-reviews.yaml</code></pre>\n<p>80:20 의 확률로 v1과 v2가 선택됨을 확인할 수 있다. </p>\n<p>virtual-service-reviews-80-20.yaml 의 내용을 아래와 같이 수정한다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">apiVersion: networking.istio.io/v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n    - reviews\n  http:\n  - route:\n    - destination:\n        host: reviews\n        subset: v1\n      weight: 0\n    - destination:\n        host: reviews\n        subset: v2\n      weight: 100</code></pre>\n<p>모든 트래픽 유입이 v2버전으로 전환됨을 확인한다.</p>\n<h2 id=\"view-the-dashboard\"><a href=\"#view-the-dashboard\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>View the dashboard</h2>\n<p>Istio 는 다른 텔레메트리 모니터링 툴과 같이 제공이 된다. 이 툴은 서비스 매시의 구조를 쉽게 들여다 볼 수 있도록 되어있어 서비스간 호출 구조와 핼쓰상태를 쉽게 이해할 수 있도록 제공된다. </p>\n<ol>\n<li>이를 위해 다음을 설치한다: [Kiali and the other addons]({{&#x3C; github_tree >}}/samples/addons). 설치가 완료될 때까지 기다린다.</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl apply -f samples/addons\n$ kubectl rollout status deployment/kiali -n istio-system\n  \nWaiting for deployment &quot;kiali&quot; rollout to finish: 0 of 1 updated replicas are available...\ndeployment &quot;kiali&quot; successfully rolled out</code></pre>\n<blockquote>\n<p>  중간에 오류가 생길 수 있으니, 그때는 다시 명령을 보내어 설치하면 된다.</p>\n</blockquote>\n<ol>\n<li>Kiali dashboard 에 접속한다</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\"> $ istioctl dashboard kiali</code></pre>\n<p>MSA Easy 에서 열수있는 포트는 808x 대만 지원되므로 iptables 명령으로 포트포워딩 한다:</p>\n<pre class=\"language-text\"><code class=\"language-text\">iptables -A PREROUTING -t nat -i eth0 -p tcp --dport 8080 -j REDIRECT --to-port 20001</code></pre>\n<blockquote>\n<p>iptables 설치:\napt-get update\napt-get install iptables</p>\n</blockquote>\n<p>Labs > 포트열기 > 8080 으로 대시보드를 열어 접속해본다.</p>\n<ol>\n<li>위의 방식으로 kiali 접속이 되지 않는 경우는 kiali svc 를 LoadBalancer로 공개해서 봐야 한다:</li>\n</ol>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl edit svc kiali -n istio-system</code></pre>\n<ul>\n<li>type: ClusterIp  부분을 찾는다</li>\n<li>i 를 입력한후</li>\n<li>LoadBalancer 로 ClusterIp 를 바꾼다</li>\n<li>ESC키를 입력후,</li>\n<li>:wq 를 입력한다</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get svc -n istio-system </code></pre>\n<p>해서 kiali의 EXTERNAL_IP 를 참고하여\nhttp://&#x3C;EXTERNAL_IP>:20001/kiali\n로 브라우저 접속한다</p>\n<ol>\n<li>\n<p>왼쪽 네비게이션 메뉴에서 <em>Graph</em> 를 선택한후 <em>Namespace</em> 드롭다운 메뉴에서, <em>default</em> 를 선택해준다.</p>\n<p>The Kiali dashboard shows an overview of your mesh with the relationships\nbetween the services in the <code>Bookinfo</code> sample application. It also provides\nfilters to visualize the traffic flow.</p>\n</li>\n</ol>\n<p><img src=\"https://istio.io/latest/docs/setup/getting-started/kiali-example2.png\" alt=\"Kiali Dashboard\"></p>\n<h2 id=\"uninstall\"><a href=\"#uninstall\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Uninstall</h2>\n<p>To delete the <code>Bookinfo</code> sample application and its configuration, see\n<a href=\"/docs/examples/bookinfo/#cleanup\"><code>Bookinfo</code> cleanup</a>.</p>\n<p>The Istio uninstall deletes the RBAC permissions and all resources hierarchically\nunder the <code>istio-system</code> namespace. It is safe to ignore errors for non-existent\nresources because they may have been deleted hierarchically.</p>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl delete -f samples/addons\n$ istioctl manifest generate --set profile=demo | kubectl delete --ignore-not-found=true -f -</code></pre>\n<p>The <code>istio-system</code> namespace is not removed by default.\nIf no longer needed, use the following command to remove it:</p>\n<pre class=\"language-text\"><code class=\"language-text\">$ kubectl delete namespace istio-system</code></pre>\n","sidebar":"business","next":"","prev":"","headings":[{"depth":1,"value":" Istio","anchor":"#service-mesh-istio"},{"depth":1,"value":" Istio","anchor":"#service-mesh-istio-1"},{"depth":2,"value":"Download & Install Istio","anchor":"#download--install-istio"},{"depth":2,"value":"Install Istio","anchor":"#install-istio"},{"depth":2,"value":"Deploy the sample application bookinfo","anchor":"#deploy-the-sample-application-bookinfo"},{"depth":2,"value":"Open the application to outside traffic","anchor":"#open-the-application-to-outside-traffic"},{"depth":3,"value":"Determining the ingress IP and ports","anchor":"#determining-the-ingress-ip-and-ports"},{"depth":3,"value":"Verify external access","anchor":"#verify-external-access"},{"depth":2,"value":"동적 트래픽 제어 테스트","anchor":"#동적-트래픽-제어-테스트"},{"depth":2,"value":"View the dashboard","anchor":"#view-the-dashboard"},{"depth":2,"value":"Uninstall","anchor":"#uninstall"}]},"allMarkdownPage":{"edges":[{"node":{"path":"/operations/service/","title":"12번가 마이크로서비스 라우터(Service) 생성"}},{"node":{"path":"/operations/ops-service-mesh-istio/","title":"[Service Mesh] Istio"}},{"node":{"path":"/operations/ops-utility/","title":"쿠버네티스 유틸리티"}},{"node":{"path":"/operations/ops-persistence-volume/","title":"파일시스템 (볼륨) 연결과 데이터베이스 설정"}},{"node":{"path":"/operations/ops-readiness/","title":"셀프힐링 & 무정지 배포 실습"}},{"node":{"path":"/operations/ops-kubernetes/","title":"Kubernetes Basic Command"}},{"node":{"path":"/operations/ops-service-mesh-istio-2/","title":"[Service Mesh] Istio-2"}},{"node":{"path":"/operations/ops-pod-status/","title":"Pod 상태값에 따른 마이크로서비스 트러블 슈팅"}},{"node":{"path":"/operations/ops-persistence-volume-efs/","title":"파일공유를 위한 NAS 스토리지 생성과 설정"}},{"node":{"path":"/operations/ops-liveness/","title":"셀프힐링 실습"}},{"node":{"path":"/operations/ops-ingress/","title":"Ingress 를 통한 진입점 통일 - Path-based routing"}},{"node":{"path":"/operations/ops-aws-setting/","title":"AWS Cloud Setup(EKS, ECR 설정)"}},{"node":{"path":"/operations/ops-ingress-virtualhost/","title":"Ingress - Virtual Host based"}},{"node":{"path":"/operations/ops-deploy-my-app/","title":"애플리케이션 패키징,도커라이징,클러스터 배포"}},{"node":{"path":"/operations/ops-autoscale/","title":"Pod Auto Scaling"}},{"node":{"path":"/operations/istio-resiliency-part2/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part2 - 서킷브레이커"}},{"node":{"path":"/operations/istio-resiliency-part1/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part1 - 타임아웃/재시도"}},{"node":{"path":"/operations/ops-argo-rollout-canary-istio/","title":"[GitOps] Argo Rollout 와 Istio 를 통한 카나리 배포"}},{"node":{"path":"/operations/k8s-monitoring/","title":"MSA 모니터링 with installing Grafana"}},{"node":{"path":"/operations/microservice-logging/","title":"마이크로서비스 통합 로깅 with EFK stack"}},{"node":{"path":"/operations/ops-anatomy-kubernetes/","title":"쿠버네티스 내부구조 분석"}},{"node":{"path":"/operations/istio-traffic/","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅"}},{"node":{"path":"/operations/apply-security-to-12st-mall/","title":"12번가 Mall에 토큰인증 적용하기"}},{"node":{"path":"/operations/azure/","title":"Azure Cloud Setup (AKS, ACR 설정)"}},{"node":{"path":"/operations/end-to-end/","title":"12번가 전체 마이크로서비스의 배포"}},{"node":{"path":"/operations/istio-msa-telemetry/","title":"[Service Mesh] MSA 모니터링 w/ Istio addon Grafana"}},{"node":{"path":"/operations/istio-metric-based-hpa/","title":"[Service Mesh] Istio Metrics based HPA"}},{"node":{"path":"/operations/gitops-argo-cd/","title":"[GitOps] Argo CD 를 통한 카나리 배포"}},{"node":{"path":"/development/pubsub-idempotency/","title":"Pub/Sub 방식의 연동 - Choreography with Idempotency"}},{"node":{"path":"/development/understanding-jpa-based-single-microservice/","title":"마이크로서비스 구현 및 동작원리 이해"}},{"node":{"path":"/development/token-based-auth/","title":"JWT Token 기반 인증 인가"}},{"node":{"path":"/development/pubsub-deadline/","title":"Pub/Sub 방식의 연동 - Choreography with Deadline added"}},{"node":{"path":"/development/ops-docker/","title":"Application Packaging with Container (Docker)"}},{"node":{"path":"/development/oauth2with-keycloak/","title":"JWT Token 기반 인증 인가 - Advanced"}},{"node":{"path":"/development/pub-sub/","title":"Pub/Sub 방식의 연동 "}},{"node":{"path":"/development/dp-cqrs/","title":"Data Projection with CQRS"}},{"node":{"path":"/development/monolith-2-misvc/","title":"Req/Res 방식의 MSA 연동 "}},{"node":{"path":"/development/kafka-connect/","title":"CDC(Change Data Capture) with Kafka"}},{"node":{"path":"/development/kafka-scaling/","title":"Kafka Scaling "}},{"node":{"path":"/development/kafka-basic/","title":"Kafka 기본 명령어 "}},{"node":{"path":"/development/kafka-retry-dlq/","title":"Kafka Retry & Dead Letter Queue "}},{"node":{"path":"/development/dp-graphql/","title":"Data Projection with GraphQL"}},{"node":{"path":"/development/gateway/","title":"API Gateway"}},{"node":{"path":"/development/dp-frontend/","title":"Data Projection with Frontend and HATEOAS"}},{"node":{"path":"/development/contract-test/","title":"Contract Test (Consumer Driven Test)"}},{"node":{"path":"/development/cna-start/","title":"단위 마이크로 서비스의 실행 "}},{"node":{"path":"/development/compensation-correlation/","title":"Pub/Sub 방식의 연동 - Compensation 과 Correlation"}},{"node":{"path":"/business/ddd-google-drive/","title":"[이벤트스토밍] - 구글 드라이브 예제"}},{"node":{"path":"/business/","title":"[이벤트스토밍] - 12번가 쇼핑몰 예제"}},{"node":{"path":"/development/circuit-breaker/","title":"Req/Res 방식에서 장애전파 차단 - 서킷브레이커 "}},{"node":{"path":"/business/eventstorming-fooddelivery/","title":"[이벤트스토밍] - DDD Food Delivery 예제"}}]}},"context":{}}