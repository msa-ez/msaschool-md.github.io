{"hash":"f58eca0934380d084e357b0b95045cf3b386277b","data":{"markdownPage":{"id":"587727c3b3ca95f00b193bd25254745c","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅","description":"","path":"/operations/istio-traffic/","timeToRead":3,"content":"<h1 id=\"service-mesh-istio-를-통한-동적-트래픽-라우팅\"><a href=\"#service-mesh-istio-%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%8F%99%EC%A0%81-%ED%8A%B8%EB%9E%98%ED%94%BD-%EB%9D%BC%EC%9A%B0%ED%8C%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>[Service Mesh] Istio 를 통한 동적 트래픽 라우팅</h1>\n<h3 id=\"traffic-mgmt--canary-배포\"><a href=\"#traffic-mgmt--canary-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Traffic Mgmt &#x26; Canary 배포</h3>\n<h4 id=\"istio-tutorial-셋업\"><a href=\"#istio-tutorial-%EC%85%8B%EC%97%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio Tutorial 셋업</h4>\n<ul>\n<li>Git repository에서 Tutorial 리소스 가져오기</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">cd /home/project\ngit clone https://github.com/redhat-developer-demos/istio-tutorial\ncd istio-tutorial</code></pre>\n<h4 id=\"네임스페이스-생성\"><a href=\"#%EB%84%A4%EC%9E%84%EC%8A%A4%ED%8E%98%EC%9D%B4%EC%8A%A4-%EC%83%9D%EC%84%B1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>네임스페이스 생성</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl create namespace tutorial</code></pre>\n<h4 id=\"customer-service-배포-생성확인\"><a href=\"#customer-service-%EB%B0%B0%ED%8F%AC-%EC%83%9D%EC%84%B1%ED%99%95%EC%9D%B8\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Customer Service 배포 생성확인</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f customer/kubernetes/Deployment.yml) -n tutorial\nkubectl describe pod (Customer Pod) -n tutorial\nkubectl create -f customer/kubernetes/Service.yml -n tutorial</code></pre>\n<h4 id=\"istio-gateway-설치-및-customer-서비스-라우팅virtualservice-설정\"><a href=\"#istio-gateway-%EC%84%A4%EC%B9%98-%EB%B0%8F-customer-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%9D%BC%EC%9A%B0%ED%8C%85virtualservice-%EC%84%A4%EC%A0%95\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio Gateway 설치 및 Customer 서비스 라우팅(VirtualService) 설정</h4>\n<pre class=\"language-text\"><code class=\"language-text\">cat customer/kubernetes/Gateway.yml\nkubectl create -f customer/kubernetes/Gateway.yml -n tutorial</code></pre>\n<h4 id=\"istio-ingressgateway를-통한-customer-서비스-확인\"><a href=\"#istio-ingressgateway%EB%A5%BC-%ED%86%B5%ED%95%9C-customer-%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%99%95%EC%9D%B8\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio-IngressGateway를 통한 Customer 서비스 확인</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get service/istio-ingressgateway -n istio-system</code></pre>\n<ul>\n<li>해당 EXTERNAL-IP가 Istio Gateway 주소</li>\n<li>Customer 서비스 호출</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">&quot;http://(istio-ingressgateway IP)/customer&quot;</code></pre>\n<h4 id=\"preference-recommendation-v1-service-배포\"><a href=\"#preference-recommendation-v1-service-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Preference, Recommendation-v1 Service 배포</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f preference/kubernetes/Deployment.yml) -n tutorial\nkubectl create -f preference/kubernetes/Service.yml -n tutorial\nkubectl apply -f &lt;(istioctl kube-inject -f recommendation/kubernetes/Deployment.yml) -n tutorial\nkubectl create -f recommendation/kubernetes/Service.yml -n tutorial</code></pre>\n<h4 id=\"istio---traffic-routing\"><a href=\"#istio---traffic-routing\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio - Traffic Routing</h4>\n<ul>\n<li>Simple Routing\npwd 로 현 위치가 /istio-tutorial/ 인지 확인\nrecommendation 서비스 추가 배포: v2</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f recommendation/kubernetes/Deployment-v2.yml) -n tutorial</code></pre>\n<h4 id=\"서비스-호출\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%98%B8%EC%B6%9C\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>서비스 호출</h4>\n<ul>\n<li>브라우저에서 Customer 서비스(Externl-IP:8080 접속) 호출</li>\n<li>F5(새로고침)를 10회 이상 클릭하여 다수의 요청 생성</li>\n</ul>\n<p>Routing 결과 확인 - Kiali(Externl-IP:20001)\n접속 서비스의 v2 의 replica 를 2로 설정</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl scale --replicas=2 deployment/recommendation-v2 -n tutorial\nkubectl get po -n tutorial</code></pre>\n<h4 id=\"customer-서비스를-10회-이상-brf5새로고침하여-서비스-호출\"><a href=\"#customer-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-10%ED%9A%8C-%EC%9D%B4%EC%83%81-brf5%EC%83%88%EB%A1%9C%EA%B3%A0%EC%B9%A8%ED%95%98%EC%97%AC-%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%98%B8%EC%B6%9C\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Customer 서비스를 10회 이상 <br>F5(새로고침)하여 서비스 호출</h4>\n<p>Routing 결과 확인 - Kiali(Externl-IP:20001) 접속</p>\n<ul>\n<li>Advanced Routing</li>\n<li>정책(VirtualService, DestinationRule) 설정 확인</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get VirtualService -n tutorial -o yaml\nkubectl get DestinationRule -n tutorial -o yaml</code></pre>\n<ul>\n<li>사용자 선호도에 따른 추천 서비스 라우팅 정책 설정</li>\n<li>version-2로 100% 라우팅</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl create -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial\nkubectl create -f istiofiles/virtual-service-recommendation-v2.yml -n tutorial</code></pre>\n<ul>\n<li>설정정책 확인</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get VirtualService -n tutorial -o yaml\nkubectl get DestinationRule -n tutorial -o yaml</code></pre>\n<ul>\n<li>서비스 확인\n브라우저에서 Customer 서비스(Externl-IP:8080 접속)호출\nKiali(Externl-IP:20001), Jaeger(External-IP:80) 에서 모니터링</li>\n</ul>\n<h4 id=\"가중치-기반-스마트-라우팅\"><a href=\"#%EA%B0%80%EC%A4%91%EC%B9%98-%EA%B8%B0%EB%B0%98-%EC%8A%A4%EB%A7%88%ED%8A%B8-%EB%9D%BC%EC%9A%B0%ED%8C%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>가중치 기반 스마트 라우팅</h4>\n<ul>\n<li>recommendation 서비스 v1의 가중치를 100으로 변경</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl replace -f istiofiles/virtual-service-recommendation-v1.yml -n tutorial</code></pre>\n<p>서비스 호출 및 Kiali(Externl-IP:20001)에서 모니터링\nVirtualService 삭제 시, Round-Robin 방식으로 동작</p>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete -f istiofiles/virtual-service-recommendation-v1.yml -n tutorial</code></pre>\n<p>Canary 라우팅 비율별 배포 정책 예시</p>\n<pre class=\"language-text\"><code class=\"language-text\">(90 : 10)\nkubectl apply -f istiofiles/virtual-service-recommendation-v1_and_v2.yml -n tutorial\n(75 : 25)\nkubectl replace -f istiofiles/virtual-service-recommendation-v1_and_v2_75_25.yml -n tutorial</code></pre>\n<h4 id=\"삭제\"><a href=\"#%EC%82%AD%EC%A0%9C\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>삭제</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete dr recommendation -n tutorial\nkubectl delete vs recommendation -n tutorial\nkubectl scale --replicas=1 deployment/recommendation-v2 -n tutorial</code></pre>\n<h4 id=\"header-정보기반-라우팅브라우저-유형별-예시\"><a href=\"#header-%EC%A0%95%EB%B3%B4%EA%B8%B0%EB%B0%98-%EB%9D%BC%EC%9A%B0%ED%8C%85%EB%B8%8C%EB%9D%BC%EC%9A%B0%EC%A0%80-%EC%9C%A0%ED%98%95%EB%B3%84-%EC%98%88%EC%8B%9C\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Header 정보기반 라우팅(브라우저 유형별 예시)</h4>\n<ul>\n<li>Firefox 브라우저로 접속 시, v2로 라우팅되도록 설정</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial\nkubectl apply -f istiofiles/virtual-service-firefox-recommendation-v2.yml -n tutorial</code></pre>\n<ul>\n<li>Firefox 브라우저와 다른 브라우저에서 접속 확인 Browser 환경이 지원되지 않을 경우</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">curl -A Safari Externl-IP:8080\ncurl -A Firefox Externl-IP:8080</code></pre>\n<h4 id=\"삭제-1\"><a href=\"#%EC%82%AD%EC%A0%9C-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>삭제</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete dr recommendation -n tutorial\nkubectl delete vs recommendation -n tutorial</code></pre>\n","sidebar":"business","next":"","prev":"","headings":[{"depth":1,"value":" Istio 를 통한 동적 트래픽 라우팅","anchor":"#service-mesh-istio-를-통한-동적-트래픽-라우팅"},{"depth":3,"value":"Traffic Mgmt & Canary 배포","anchor":"#traffic-mgmt--canary-배포"},{"depth":4,"value":"Istio Tutorial 셋업","anchor":"#istio-tutorial-셋업"},{"depth":4,"value":"네임스페이스 생성","anchor":"#네임스페이스-생성"},{"depth":4,"value":"Customer Service 배포 생성확인","anchor":"#customer-service-배포-생성확인"},{"depth":4,"value":"Istio Gateway 설치 및 Customer 서비스 라우팅(VirtualService) 설정","anchor":"#istio-gateway-설치-및-customer-서비스-라우팅virtualservice-설정"},{"depth":4,"value":"Istio-IngressGateway를 통한 Customer 서비스 확인","anchor":"#istio-ingressgateway를-통한-customer-서비스-확인"},{"depth":4,"value":"Preference, Recommendation-v1 Service 배포","anchor":"#preference-recommendation-v1-service-배포"},{"depth":4,"value":"Istio - Traffic Routing","anchor":"#istio---traffic-routing"},{"depth":4,"value":"서비스 호출","anchor":"#서비스-호출"},{"depth":4,"value":"Customer 서비스를 10회 이상 F5(새로고침)하여 서비스 호출","anchor":"#customer-서비스를-10회-이상-brf5새로고침하여-서비스-호출"},{"depth":4,"value":"가중치 기반 스마트 라우팅","anchor":"#가중치-기반-스마트-라우팅"},{"depth":4,"value":"삭제","anchor":"#삭제"},{"depth":4,"value":"Header 정보기반 라우팅(브라우저 유형별 예시)","anchor":"#header-정보기반-라우팅브라우저-유형별-예시"},{"depth":4,"value":"삭제","anchor":"#삭제-1"}]},"allMarkdownPage":{"edges":[{"node":{"path":"/operations/ops-service-mesh-istio/","title":"[Service Mesh] Istio"}},{"node":{"path":"/operations/ops-utility/","title":"쿠버네티스 유틸리티"}},{"node":{"path":"/operations/ops-readiness/","title":"무정지 배포 실습"}},{"node":{"path":"/operations/ops-persistence-volume/","title":"파일시스템 (볼륨) 연결과 데이터베이스 설정"}},{"node":{"path":"/business/zero-based-cna/","title":"[설계] ES모델 기반 Inner 아키텍처 이해"}},{"node":{"path":"/development/dp-graphql/","title":"[구현] 데이터프로젝션-GraphQL"}},{"node":{"path":"/operations/ops-liveness/","title":"셀프힐링 실습"}},{"node":{"path":"/operations/ops-ingress-virtualhost/","title":"Ingress - Virtual Host based"}},{"node":{"path":"/operations/ops-ingress/","title":"Ingress 를 통한 진입점 통일 - Path-based routing"}},{"node":{"path":"/operations/ops-kubernetes/","title":"Kubernetes Basic Commands"}},{"node":{"path":"/operations/ops-deploy-my-app/","title":"애플리케이션 패키징,도커라이징,클러스터 배포"}},{"node":{"path":"/operations/ops-argo-rollout-canary-istio/","title":"[GitOps] Argo Rollout 와 Istio 를 통한 카나리 배포"}},{"node":{"path":"/operations/ops-autoscale/","title":"Pod Auto Scaling"}},{"node":{"path":"/operations/ops-aws-setting/","title":"AWS Cloud Setup(EKS, ECR 설정)"}},{"node":{"path":"/operations/ops-anatomy-kubernetes/","title":"쿠버네티스 내부구조 분석"}},{"node":{"path":"/operations/msa-logging/","title":"MSA 로깅 with EFK Stack"}},{"node":{"path":"/operations/istio-traffic/","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅"}},{"node":{"path":"/operations/k8s-monitoring/","title":"MSA 모니터링 with installing Grafana"}},{"node":{"path":"/operations/istio-resiliency-part2/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part2 - 서킷브레이커"}},{"node":{"path":"/operations/istio-resiliency-part1/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part1 - 타임아웃/재시도"}},{"node":{"path":"/operations/istio-msa-telemetry/","title":"[Service Mesh] MSA 모니터링 w/ Istio addon Grafana"}},{"node":{"path":"/operations/azure/","title":"Azure Cloud Setup (AKS, ACR 설정)"}},{"node":{"path":"/operations/end-to-end/","title":"12번가 전체 마이크로서비스의 배포"}},{"node":{"path":"/operations/gitops-argo-cd/","title":"[GitOps] Argo CD 를 통한 카나리 배포"}},{"node":{"path":"/development/ops-docker/","title":"[빌드] Docker Image Build & Push"}},{"node":{"path":"/development/keycloak-oauth2-3/","title":"Fine grained RBAC w/ Resource Server"}},{"node":{"path":"/development/oauth2withkeycloak/","title":"JWT토큰 기반 인증인가 w/ Keycloak Authz-svr"}},{"node":{"path":"/development/oauth2/","title":"JWT토큰 기반 인증인가 w/ Spring Authz-svr"}},{"node":{"path":"/development/monolith2misvc/","title":"[구현] Req/Res 방식의 MSA 연동"}},{"node":{"path":"/development/keycloak-oauth2-1/","title":"Keycloak Authorization 서버 설정"}},{"node":{"path":"/development/kafka-retry-dlq/","title":"Retry & Dead Letter Queue"}},{"node":{"path":"/development/kafka-scaling/","title":"Kafka 스케일링"}},{"node":{"path":"/development/keycloak-oauth2-2/","title":"Keycloak OIDC w/ OAuth2 Client"}},{"node":{"path":"/development/kafka-base/","title":"[pre-lab] 카프카 연습"}},{"node":{"path":"/development/gateway/","title":"[구현] 게이트웨이를 통한 진입점 통일"}},{"node":{"path":"/development/front-end/","title":"프론트엔드 개발"}},{"node":{"path":"/development/kafka-manual-commit/","title":"Kafka 수동커밋"}},{"node":{"path":"/development/dp-cqrs/","title":"[구현] 데이터프로젝션-CQRS"}},{"node":{"path":"/development/dp-composite-svc/","title":"[구현] 데이터프로젝션-컴포지트서비스"}},{"node":{"path":"/development/cqrs-modeling/","title":"[pre-lab] CQRS 샘플 모델링"}},{"node":{"path":"/development/contract-test/","title":"[테스트] Consumer Driven Test 기반 Contract Test"}},{"node":{"path":"/development/cna-pubsub2/","title":"[구현] Pub/Sub - Compensation and Correlation"}},{"node":{"path":"/development/cna-start/","title":"[구현] 마이크로서비스의 실행"}},{"node":{"path":"/development/cna-pubsub/","title":"[구현] Pub/Sub 방식의 MSA 연동"}},{"node":{"path":"/development/circuitbreaker/","title":"[구현] Req/Res 방식에서 장애전파 차단(서킷브레이커 패턴)"}},{"node":{"path":"/development/capstone-project-1/","title":"[Capstone Prj.] Simple Mall - Scenario/Modeling"}},{"node":{"path":"/development/capstone-project-2/","title":"[Capstone Prj.] Simple Mall - Implementation"}},{"node":{"path":"/business/ddd-google-drive/","title":"[이벤트스토밍] DDD 구글 드라이브 예제"}},{"node":{"path":"/development/advanced-connect/","title":"Kafka Connect"}},{"node":{"path":"/business/","title":"[분석] DDD 이벤트의 도출 - 12번가 쇼핑몰"}},{"node":{"path":"/business/design-to-code/","title":"[설계] ES모델기반 템플릿 코드 분석"}},{"node":{"path":"/business/eventstorming-fooddelivery/","title":"[이벤트스토밍] DDD Food Delivery 예제"}},{"node":{"path":"/business/collaborative-eventstorming/","title":"[이벤트스토밍] Collaborative Eventstorming"}}]}},"context":{}}