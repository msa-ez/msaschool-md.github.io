{"hash":"49f02bf9a1ddbf017efeb189302ebd145a2955d8","data":{"markdownPage":{"id":"587727c3b3ca95f00b193bd25254745c","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅","description":"","path":"/operations/istio-traffic/","timeToRead":4,"content":"<h1 id=\"service-mesh-istio-를-통한-동적-트래픽-라우팅\"><a href=\"#service-mesh-istio-%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%8F%99%EC%A0%81-%ED%8A%B8%EB%9E%98%ED%94%BD-%EB%9D%BC%EC%9A%B0%ED%8C%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>[Service Mesh] Istio 를 통한 동적 트래픽 라우팅</h1>\n<h1 id=\"service-mesh-istio-를-통한-동적-트래픽-라우팅-1\"><a href=\"#service-mesh-istio-%EB%A5%BC-%ED%86%B5%ED%95%9C-%EB%8F%99%EC%A0%81-%ED%8A%B8%EB%9E%98%ED%94%BD-%EB%9D%BC%EC%9A%B0%ED%8C%85-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>[Service Mesh] Istio 를 통한 동적 트래픽 라우팅</h1>\n<h3 id=\"traffic-mgmt--canary-배포\"><a href=\"#traffic-mgmt--canary-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Traffic Mgmt &#x26; Canary 배포</h3>\n<p>예제를 통해 Istio가 지원하는 동적 트레픽 라우팅을 이해하고, 앞서 설치한 Add-on 서버들의 시각화된 화면으로 적용 결과를 확인한다.</p>\n<p>대표적인 서비스 메시의 카나리(Canary) 배포전략을 실습해 보고 Advanced한 서비스 리자일런스를 학습한다.</p>\n<h4 id=\"istio-tutorial-셋업\"><a href=\"#istio-tutorial-%EC%85%8B%EC%97%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio Tutorial 셋업</h4>\n<ul>\n<li>Git repository에서 Tutorial 리소스에서 Istio 트래픽 예제가 있는 저장소를 복제한다.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/redhat-developer-demos/istio-tutorial\ncd istio-tutorial</code></pre>\n<h4 id=\"네임스페이스-생성\"><a href=\"#%EB%84%A4%EC%9E%84%EC%8A%A4%ED%8E%98%EC%9D%B4%EC%8A%A4-%EC%83%9D%EC%84%B1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>네임스페이스 생성</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl create namespace tutorial</code></pre>\n<h4 id=\"customer-예제-서비스-배포\"><a href=\"#customer-%EC%98%88%EC%A0%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Customer 예제 서비스 배포</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f customer/kubernetes/Deployment.yml) -n tutorial\nkubectl describe pod (Customer Pod) -n tutorial\nkubectl create -f customer/kubernetes/Service.yml -n tutorial</code></pre>\n<h4 id=\"istio-gateway-설치-및-customer-서비스-라우팅virtualservice-설정\"><a href=\"#istio-gateway-%EC%84%A4%EC%B9%98-%EB%B0%8F-customer-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%9D%BC%EC%9A%B0%ED%8C%85virtualservice-%EC%84%A4%EC%A0%95\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio Gateway 설치 및 Customer 서비스 라우팅(VirtualService) 설정</h4>\n<pre class=\"language-text\"><code class=\"language-text\">cat customer/kubernetes/Gateway.yml\nkubectl create -f customer/kubernetes/Gateway.yml -n tutorial</code></pre>\n<h4 id=\"istio-ingressgateway를-통한-customer-서비스-확인\"><a href=\"#istio-ingressgateway%EB%A5%BC-%ED%86%B5%ED%95%9C-customer-%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%99%95%EC%9D%B8\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio-IngressGateway를 통한 Customer 서비스 확인</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get service/istio-ingressgateway -n istio-system</code></pre>\n<ul>\n<li>Customer 서비스 호출</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">&quot;http://(istio-ingressgateway IP)/customer&quot;</code></pre>\n<h4 id=\"예제-preference-recommendation-v1-service-배포\"><a href=\"#%EC%98%88%EC%A0%9C-preference-recommendation-v1-service-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>예제 Preference, Recommendation-v1 Service 배포</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f preference/kubernetes/Deployment.yml) -n tutorial\nkubectl create -f preference/kubernetes/Service.yml -n tutorial\nkubectl apply -f &lt;(istioctl kube-inject -f recommendation/kubernetes/Deployment.yml) -n tutorial\nkubectl create -f recommendation/kubernetes/Service.yml -n tutorial</code></pre>\n<h3 id=\"istio---traffic-routing\"><a href=\"#istio---traffic-routing\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Istio - Traffic Routing</h3>\n<h4 id=\"simple-routing\"><a href=\"#simple-routing\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Simple Routing</h4>\n<pre class=\"language-text\"><code class=\"language-text\">cd istio-tutorial</code></pre>\n<ul>\n<li>recommendation 두번째 서비스 배포</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f &lt;(istioctl kube-inject -f recommendation/kubernetes/Deployment-v2.yml) -n tutorial</code></pre>\n<h4 id=\"서비스-호출-및-확인\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%98%B8%EC%B6%9C-%EB%B0%8F-%ED%99%95%EC%9D%B8\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>서비스 호출 및 확인</h4>\n<ul>\n<li>브라우저에서 Ingressgateway를 경유하는 Customer 서비스 호출</li>\n<li>F5(새로고침)를 10회 이상 클릭하여 수회이상의 요청 생성한다.</li>\n<li>Routing 결과 확인 - Kiali(Externl-IP:20001)</li>\n<li>추천 서비스 v2 의 replica 를 두개로 스케일 아웃한다.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl scale --replicas=2 deployment/recommendation-v2 -n tutorial\nkubectl get po -n tutorial</code></pre>\n<ul>\n<li>Customer 서비스에 10회 이상 워크로드를 발생시킨다.</li>\n<li>Routing 결과 확인 - Kiali(Externl-IP:20001) 접속</li>\n</ul>\n<h4 id=\"advanced-routing\"><a href=\"#advanced-routing\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Advanced Routing</h4>\n<p>Istio의 CRD(Custom Resouce Definition) 객체를 통해 advanced한 트래픽 정책을 설정하고, Policy기반의 동적 트래픽 라우팅을 확인한다.</p>\n<ul>\n<li>설정된 정책(VirtualService, DestinationRule) 확인</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get VirtualService -n tutorial -o yaml\nkubectl get DestinationRule -n tutorial -o yaml</code></pre>\n<h4 id=\"사용자-선호도에-따른-추천-서비스-라우팅-정책-설정\"><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%84%A0%ED%98%B8%EB%8F%84%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%B6%94%EC%B2%9C-%EC%84%9C%EB%B9%84%EC%8A%A4-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A0%95%EC%B1%85-%EC%84%A4%EC%A0%95\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>사용자 선호도에 따른 추천 서비스 라우팅 정책 설정</h4>\n<ul>\n<li>기존 버전과 신규버전을 각각 Destination Rule 객체를 통해 대상 서비스로 정의한다.</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl create -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial</code></pre>\n<ul>\n<li>기존 버전(version-1)으로 모든 트래픽이 전송되도록 라우팅 룰을 설정한다. </li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl create -f istiofiles/virtual-service-recommendation-v1.yml -n tutorial</code></pre>\n<ul>\n<li>설정정책 확인</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl get VirtualService -n tutorial -o yaml\nkubectl get DestinationRule -n tutorial -o yaml</code></pre>\n<h4 id=\"서비스-호출-및-확인-1\"><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4-%ED%98%B8%EC%B6%9C-%EB%B0%8F-%ED%99%95%EC%9D%B8-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>서비스 호출 및 확인</h4>\n<ul>\n<li>브라우저에서 Ingressgateway를 경유하는 Customer 서비스 호출</li>\n<li>F5(새로고침)를 10회 이상 클릭하여 수회이상의 요청 생성한다.</li>\n<li>Kiali(Externl-IP:20001), Jaeger(External-IP:80) 에서 모니터링해 본다</li>\n</ul>\n<h3 id=\"가중치-기반-카나리-배포\"><a href=\"#%EA%B0%80%EC%A4%91%EC%B9%98-%EA%B8%B0%EB%B0%98-%EC%B9%B4%EB%82%98%EB%A6%AC-%EB%B0%B0%ED%8F%AC\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>가중치 기반 카나리 배포</h3>\n<ul>\n<li>Canary 라우팅 비율별 배포 정책 예시</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">(90 : 10)\nkubectl apply -f istiofiles/virtual-service-recommendation-v1_and_v2.yml -n tutorial\n(75 : 25)\nkubectl replace -f istiofiles/virtual-service-recommendation-v1_and_v2_75_25.yml -n tutorial</code></pre>\n<ul>\n<li>recommendation 서비스 v2의 가중치를 100으로 변경</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl replace -f istiofiles/virtual-service-recommendation-v2.yml -n tutorial</code></pre>\n<h4 id=\"삭제\"><a href=\"#%EC%82%AD%EC%A0%9C\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>삭제</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete dr recommendation -n tutorial\nkubectl delete vs recommendation -n tutorial\nkubectl scale --replicas=1 deployment/recommendation-v2 -n tutorial</code></pre>\n<h3 id=\"header정보-기반-스마트-라우팅\"><a href=\"#header%EC%A0%95%EB%B3%B4-%EA%B8%B0%EB%B0%98-%EC%8A%A4%EB%A7%88%ED%8A%B8-%EB%9D%BC%EC%9A%B0%ED%8C%85\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>Header정보 기반 스마트 라우팅</h3>\n<p>유입되는 요청 브라우저, 또는 사용자 Profile기반 라우팅이 가능하다. 마이크로서비스 배포팀 또는 부서일 경우에만 새 버전(v.2)으로 라우팅하여 고객 피해를 최소화 할 수 있다.</p>\n<ul>\n<li>Firefox 브라우저로 접속 시, v2로 라우팅되도록 설정</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl apply -f istiofiles/destination-rule-recommendation-v1-v2.yml -n tutorial\nkubectl apply -f istiofiles/virtual-service-firefox-recommendation-v2.yml -n tutorial</code></pre>\n<ul>\n<li>Firefox 브라우저와 다른 브라우저에서 접속 확인 Browser 환경이 지원되지 않을 경우</li>\n</ul>\n<pre class=\"language-text\"><code class=\"language-text\">curl -A Safari Externl-IP:8080\ncurl -A Firefox Externl-IP:8080</code></pre>\n<h4 id=\"삭제-1\"><a href=\"#%EC%82%AD%EC%A0%9C-1\" aria-hidden=\"true\"><span class=\"icon icon-link\"></span></a>삭제</h4>\n<pre class=\"language-text\"><code class=\"language-text\">kubectl delete dr recommendation -n tutorial\nkubectl delete vs recommendation -n tutorial</code></pre>\n","sidebar":"business","next":"","prev":"","headings":[{"depth":1,"value":" Istio 를 통한 동적 트래픽 라우팅","anchor":"#service-mesh-istio-를-통한-동적-트래픽-라우팅"},{"depth":1,"value":" Istio 를 통한 동적 트래픽 라우팅","anchor":"#service-mesh-istio-를-통한-동적-트래픽-라우팅-1"},{"depth":3,"value":"Traffic Mgmt & Canary 배포","anchor":"#traffic-mgmt--canary-배포"},{"depth":4,"value":"Istio Tutorial 셋업","anchor":"#istio-tutorial-셋업"},{"depth":4,"value":"네임스페이스 생성","anchor":"#네임스페이스-생성"},{"depth":4,"value":"Customer 예제 서비스 배포","anchor":"#customer-예제-서비스-배포"},{"depth":4,"value":"Istio Gateway 설치 및 Customer 서비스 라우팅(VirtualService) 설정","anchor":"#istio-gateway-설치-및-customer-서비스-라우팅virtualservice-설정"},{"depth":4,"value":"Istio-IngressGateway를 통한 Customer 서비스 확인","anchor":"#istio-ingressgateway를-통한-customer-서비스-확인"},{"depth":4,"value":"예제 Preference, Recommendation-v1 Service 배포","anchor":"#예제-preference-recommendation-v1-service-배포"},{"depth":3,"value":"Istio - Traffic Routing","anchor":"#istio---traffic-routing"},{"depth":4,"value":"Simple Routing","anchor":"#simple-routing"},{"depth":4,"value":"서비스 호출 및 확인","anchor":"#서비스-호출-및-확인"},{"depth":4,"value":"Advanced Routing","anchor":"#advanced-routing"},{"depth":4,"value":"사용자 선호도에 따른 추천 서비스 라우팅 정책 설정","anchor":"#사용자-선호도에-따른-추천-서비스-라우팅-정책-설정"},{"depth":4,"value":"서비스 호출 및 확인","anchor":"#서비스-호출-및-확인-1"},{"depth":3,"value":"가중치 기반 카나리 배포","anchor":"#가중치-기반-카나리-배포"},{"depth":4,"value":"삭제","anchor":"#삭제"},{"depth":3,"value":"Header정보 기반 스마트 라우팅","anchor":"#header정보-기반-스마트-라우팅"},{"depth":4,"value":"삭제","anchor":"#삭제-1"}]},"allMarkdownPage":{"edges":[{"node":{"path":"/operations/service/","title":"12번가 마이크로서비스 라우터(Service) 생성"}},{"node":{"path":"/operations/ops-service-mesh-istio/","title":"[Service Mesh] Istio"}},{"node":{"path":"/operations/ops-utility/","title":"쿠버네티스 유틸리티"}},{"node":{"path":"/operations/ops-persistence-volume/","title":"파일시스템 (볼륨) 연결과 데이터베이스 설정"}},{"node":{"path":"/operations/ops-readiness/","title":"셀프힐링 & 무정지 배포 실습"}},{"node":{"path":"/operations/ops-kubernetes/","title":"Kubernetes Basic Command"}},{"node":{"path":"/operations/ops-service-mesh-istio-2/","title":"[Service Mesh] Istio-2"}},{"node":{"path":"/operations/ops-pod-status/","title":"Pod 상태값에 따른 마이크로서비스 트러블 슈팅"}},{"node":{"path":"/operations/ops-persistence-volume-efs/","title":"파일공유를 위한 NAS 스토리지 생성과 설정"}},{"node":{"path":"/operations/ops-liveness/","title":"셀프힐링 실습"}},{"node":{"path":"/operations/ops-ingress/","title":"Ingress 를 통한 진입점 통일 - Path-based routing"}},{"node":{"path":"/operations/ops-aws-setting/","title":"AWS Cloud Setup(EKS, ECR 설정)"}},{"node":{"path":"/operations/ops-ingress-virtualhost/","title":"Ingress - Virtual Host based"}},{"node":{"path":"/operations/ops-deploy-my-app/","title":"애플리케이션 패키징,도커라이징,클러스터 배포"}},{"node":{"path":"/operations/ops-autoscale/","title":"Pod Auto Scaling"}},{"node":{"path":"/operations/istio-resiliency-part2/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part2 - 서킷브레이커"}},{"node":{"path":"/operations/istio-resiliency-part1/","title":"[Service Mesh] Istio 를 통한 서비스 회복성 Part1 - 타임아웃/재시도"}},{"node":{"path":"/operations/ops-argo-rollout-canary-istio/","title":"[GitOps] Argo Rollout 와 Istio 를 통한 카나리 배포"}},{"node":{"path":"/operations/k8s-monitoring/","title":"MSA 모니터링 with installing Grafana"}},{"node":{"path":"/operations/microservice-logging/","title":"마이크로서비스 통합 로깅 with EFK stack"}},{"node":{"path":"/operations/ops-anatomy-kubernetes/","title":"쿠버네티스 내부구조 분석"}},{"node":{"path":"/operations/istio-traffic/","title":"[Service Mesh] Istio 를 통한 동적 트래픽 라우팅"}},{"node":{"path":"/operations/apply-security-to-12st-mall/","title":"12번가 Mall에 토큰인증 적용하기"}},{"node":{"path":"/operations/azure/","title":"Azure Cloud Setup (AKS, ACR 설정)"}},{"node":{"path":"/operations/end-to-end/","title":"12번가 전체 마이크로서비스의 배포"}},{"node":{"path":"/operations/istio-msa-telemetry/","title":"[Service Mesh] MSA 모니터링 w/ Istio addon Grafana"}},{"node":{"path":"/operations/istio-metric-based-hpa/","title":"[Service Mesh] Istio Metrics based HPA"}},{"node":{"path":"/operations/gitops-argo-cd/","title":"[GitOps] Argo CD 를 통한 카나리 배포"}},{"node":{"path":"/development/pubsub-idempotency/","title":"Pub/Sub 방식의 연동 - Choreography with Idempotency"}},{"node":{"path":"/development/understanding-jpa-based-single-microservice/","title":"마이크로서비스 구현 및 동작원리 이해"}},{"node":{"path":"/development/token-based-auth/","title":"JWT Token 기반 인증 인가"}},{"node":{"path":"/development/pubsub-deadline/","title":"Pub/Sub 방식의 연동 - Choreography with Deadline added"}},{"node":{"path":"/development/ops-docker/","title":"Application Packaging with Container (Docker)"}},{"node":{"path":"/development/oauth2with-keycloak/","title":"JWT Token 기반 인증 인가 - Advanced"}},{"node":{"path":"/development/pub-sub/","title":"Pub/Sub 방식의 연동 "}},{"node":{"path":"/development/dp-cqrs/","title":"Data Projection with CQRS"}},{"node":{"path":"/development/monolith-2-misvc/","title":"Req/Res 방식의 MSA 연동 "}},{"node":{"path":"/development/kafka-connect/","title":"CDC(Change Data Capture) with Kafka"}},{"node":{"path":"/development/kafka-scaling/","title":"Kafka Scaling "}},{"node":{"path":"/development/kafka-basic/","title":"Kafka 기본 명령어 "}},{"node":{"path":"/development/kafka-retry-dlq/","title":"Kafka Retry & Dead Letter Queue "}},{"node":{"path":"/development/dp-graphql/","title":"Data Projection with GraphQL"}},{"node":{"path":"/development/gateway/","title":"API Gateway"}},{"node":{"path":"/development/dp-frontend/","title":"Data Projection with Frontend and HATEOAS"}},{"node":{"path":"/development/contract-test/","title":"Contract Test (Consumer Driven Test)"}},{"node":{"path":"/development/cna-start/","title":"단위 마이크로 서비스의 실행 "}},{"node":{"path":"/development/compensation-correlation/","title":"Pub/Sub 방식의 연동 - Compensation 과 Correlation"}},{"node":{"path":"/business/ddd-google-drive/","title":"[이벤트스토밍] - 구글 드라이브 예제"}},{"node":{"path":"/business/","title":"[이벤트스토밍] - 12번가 쇼핑몰 예제"}},{"node":{"path":"/development/circuit-breaker/","title":"Req/Res 방식에서 장애전파 차단 - 서킷브레이커 "}},{"node":{"path":"/business/eventstorming-fooddelivery/","title":"[이벤트스토밍] - DDD Food Delivery 예제"}}]}},"context":{}}